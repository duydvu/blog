<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Giá»›i thiá»‡u vá» Data Version Control dÃ¹ng cho cÃ¡c dá»± Ã¡n AI/ML</title>
    <link href="/2023/10/16/Ung-dung-Data-Version-Control-cho-du-an-AI-ML/"/>
    <url>/2023/10/16/Ung-dung-Data-Version-Control-cho-du-an-AI-ML/</url>
    
    <content type="html"><![CDATA[<p>Má»™t trong nhá»¯ng váº¥n Ä‘á» quan trá»ng nháº¥t trong cÃ¡c dá»± Ã¡n AI/ML lÃ  quáº£n lÃ½ dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh. CÃ¡c dá»± Ã¡n AI/ML thÆ°á»ng cÃ³ nhiá»u ngÆ°á»i tham gia vÃ  thÆ°á»ng xuyÃªn pháº£i thay Ä‘á»•i. Nhá»¯ng thay Ä‘á»•i cÃ³ thá»ƒ lÃ  thay Ä‘á»•i vá» dá»¯ liá»‡u, vá» kiáº¿n trÃºc mÃ´ hÃ¬nh, thay Ä‘á»•i tham sá»‘, thay Ä‘á»•i cÃ¡ch thá»©c huáº¥n luyá»‡n, thay Ä‘á»•i cÃ¡ch thá»©c Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh, thay Ä‘á»•i cÃ¡ch thá»©c triá»ƒn khai mÃ´ hÃ¬nh, v.vâ€¦</p><p>Náº¿u chÃºng ta khÃ´ng quáº£n lÃ½ dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh má»™t cÃ¡ch hiá»‡u quáº£ thÃ¬ sáº½ dá»… dáº«n Ä‘áº¿n nhiá»u tÃ¬nh huá»‘ng khÃ´ng mong muá»‘n. VÃ­ dá»¥ nhÆ°:</p><ul><li><p>TÃ¬nh huá»‘ng 1:</p><ul><li>Báº¡n train má»™t mÃ´ hÃ¬nh vá»›i má»™t táº­p dá»¯ liá»‡u.</li><li>Báº¡n chá»‰nh sá»­a táº­p dá»¯ liá»‡u vÃ  train láº¡i mÃ´ hÃ¬nh nhÆ°ng khÃ´ng lÆ°u láº¡i phiÃªn báº£n cÅ©.</li><li>Khi Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh, báº¡n nháº­n tháº¥y mÃ´ hÃ¬nh má»›i khÃ´ng tá»‘t báº±ng mÃ´ hÃ¬nh cÅ©.</li><li>Báº¡n muá»‘n quay láº¡i phiÃªn báº£n táº­p dá»¯ liá»‡u cÅ© Ä‘á»ƒ tÃ¬m ra nguyÃªn nhÃ¢n nhÆ°ng khÃ´ng thá»ƒ vÃ¬ báº¡n Ä‘Ã£ xÃ³a nÃ³ Ä‘i rá»“i ğŸ˜°</li><li>Táº¥t nhiÃªn lÃ  viá»‡c lÆ°u 1 báº£n backup má»—i khi chá»‰nh sá»­a táº­p dá»¯ liá»‡u sáº½ giÃºp trÃ¡nh Ä‘Æ°á»£c tÃ¬nh huá»‘ng nÃ y. NhÆ°ng khi sá»‘ láº§n chá»‰nh sá»­a nhiá»u lÃªn khiáº¿n cho sá»‘ báº£n backup cÃ ng nhiá»u, báº¡n sáº½ ráº¥t khÃ³ quáº£n lÃ½ chÃºng.</li></ul></li><li><p>TÃ¬nh huá»‘ng 2: Báº¡n vá»«a Ä‘Æ°á»£c tham gia vÃ o 1 dá»± Ã¡n Ä‘ang trong quÃ¡ trÃ¬nh phÃ¡t triá»ƒn. Dá»± Ã¡n nÃ y trÆ°á»›c Ä‘Ã¢y Ä‘Æ°á»£c phá»¥ trÃ¡ch bá»Ÿi 1 anh Ä‘á»“ng nghiá»‡p trong team. Báº¡n nháº­n code &amp; data tá»« áº£nh vá» vÃ  báº¯t Ä‘áº§u cÃ´ng viá»‡c.</p><ul><li>Báº¡n: â€œEm Ä‘Ã£ thay Ä‘á»•i tham sá»‘ vÃ  train láº¡i model. Model má»›i cÃ³ Ä‘á»™ chÃ­nh xÃ¡c cao hÆ¡n model cÅ© mÃ  anh train cÃ¡ch Ä‘Ã¢y 3 thÃ¡ng.â€</li><li>Anh Ä‘á»“ng nghiá»‡p: â€œTuyá»‡t vá»i! Äá»ƒ anh Ä‘Ã¡nh giÃ¡ model cá»§a em trÆ°á»›c khi deploy nÃ³ lÃªn prod nhÃ©.â€</li><li>Anh Ä‘á»“ng nghiá»‡p: â€œHmmmâ€¦ Model cá»§a em cÃ³ váº» khÃ´ng chÃ­nh xÃ¡c báº±ng model cá»§a anh. Model cá»§a em lÃ  96% trong khi cá»§a anh lÃ  98%.â€</li><li>Báº¡n: â€œSao láº¡i tháº¿ áº¡? Trong report cá»§a anh vá» model Ä‘Æ°á»£c train 3 thÃ¡ng trÆ°á»›c thÃ¬ Ä‘á»™ chÃ­nh xÃ¡c chá»‰ lÃ  94% thÃ´i mÃ !â€</li><li>Anh Ä‘á»“ng nghiá»‡p: â€œLáº¡ nhá»‰? Ã€ anh nhá»› rá»“i. TrÆ°á»›c khi em join project nÃ y cÃ¡ch Ä‘Ã¢y 1 tuáº§n thÃ¬ anh cÃ³ lÃ m sáº¡ch táº­p test nÃªn khiáº¿n cho model chÃ­nh xÃ¡c hÆ¡n. ChÆ°a ká»‹p update report thÃ¬ em Ä‘Ã£ train láº¡i rá»“i. ğŸ˜…â€</li><li>Báº¡n: â€œâ€¦â€</li></ul><p>á» Ä‘Ã¢y, viá»‡c khÃ´ng tracking thay Ä‘á»•i cá»§a táº­p dá»¯ liá»‡u khiáº¿n cho báº¡n khÃ´ng biáº¿t Ä‘Æ°á»£c ráº±ng model trÆ°á»›c Ä‘Ã¢y Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ trÃªn táº­p dá»¯ liá»‡u nhÆ° tháº¿ nÃ o.</p></li></ul><p>TrÆ°á»›c Ä‘Ã¢y, mÃ¬nh Ä‘Ã£ tá»«ng Ä‘áº·t tÃªn cho cÃ¡c táº­p dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh vá»›i nhá»¯ng cÃ¡i tÃªn nhÆ°: model_v1, model_v2, model_new, data_raw, data_cleaned, data_preprocessed, v.vâ€¦ Rá»“i 1 thá»i gian sau, mÃ¬nh láº¡i quÃªn mÃ¬nh Ä‘Ã£ lÃ m gÃ¬ vá»›i nhá»¯ng táº­p dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh nÃ y. model_v1 train báº±ng táº­p dá»¯ liá»‡u nÃ o? learning rate lÃ  bao nhiÃªu? Rá»“i cáº£ tá»· cÃ¢u há»i khÃ¡c mÃ  bÃ¢y giá» chá»‰ cÃ³ cÃ¡ch lÃ  dÃ¹ng mÃ¡y du hÃ nh thá»i gian cá»§a Doraemon má»›i cÃ³ thá»ƒ tráº£ lá»i Ä‘Æ°á»£c ğŸ˜‚.</p><p>Qua nhá»¯ng vÃ­ dá»¥ trÃªn, cháº¯c háº³n báº¡n Ä‘Ã£ pháº§n nÃ o hÃ¬nh dung Ä‘Æ°á»£c táº§m quan trá»ng cá»§a viá»‡c quáº£n lÃ½ dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh trong cÃ¡c dá»± Ã¡n AI/ML.</p><p>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, cÃ³ ráº¥t nhiá»u cÃ´ng cá»¥ Ä‘Æ°á»£c phÃ¡t triá»ƒn nhÆ°ng trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ giá»›i thiá»‡u vá» <a href="https://dvc.org/">Data Version Control (DVC)</a>.</p><h1 id="Data-Version-Control-la-gi"><a href="#Data-Version-Control-la-gi" class="headerlink" title="Data Version Control lÃ  gÃ¬?"></a>Data Version Control lÃ  gÃ¬?</h1><p>Data Version Control (DVC) lÃ  má»™t cÃ´ng cá»¥ mÃ£ nguá»“n má»Ÿ dÃ¹ng Ä‘á»ƒ quáº£n lÃ½ phiÃªn báº£n cho dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh. Trong phÃ¡t triá»ƒn pháº§n má»m thÃ´ng thÆ°á»ng, chÃºng ta Ä‘Ã£ quÃ¡ quen thuá»™c vá»›i viá»‡c sá»­ dá»¥ng Git Ä‘á»ƒ quáº£n lÃ½ phiÃªn báº£n cho code. Tuy nhiÃªn, Git khÃ´ng phÃ¹ há»£p Ä‘á»ƒ quáº£n lÃ½ phiÃªn báº£n cho dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh. DVC ra Ä‘á»i Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y.</p><p>DVC Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ hoáº¡t Ä‘á»™ng dá»±a trÃªn Git. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  trong cÃ¹ng 1 repo, báº¡n vá»«a cÃ³ thá»ƒ dÃ¹ng Git Ä‘á»ƒ quáº£n lÃ½ code, vá»«a cÃ³ thá»ƒ dÃ¹ng DVC Ä‘á»ƒ quáº£n lÃ½ dá»¯ liá»‡u vÃ  mÃ´ hÃ¬nh.</p><p>Nhá» hoáº¡t Ä‘á»™ng dá»±a trÃªn Git, DVC táº­n dá»¥ng Ä‘Æ°á»£c cÃ¡c tÃ­nh nÄƒng máº¡nh máº½ cá»§a Git nhÆ°: branch, tag. Báº¡n cÃ³ thá»ƒ táº¡o nhiá»u branch, má»—i branch chá»©a 1 táº­p dá»¯ liá»‡u khÃ¡c nhau. Báº¡n cÃ³ thá»ƒ táº¡o tag má»—i khi train xong 1 mÃ´ hÃ¬nh.</p><p><img src="/2023/10/16/Ung-dung-Data-Version-Control-cho-du-an-AI-ML/dvc.png" alt="Nguá»“n: dvc.org"></p><h1 id="Bat-dau-su-dung-DVC"><a href="#Bat-dau-su-dung-DVC" class="headerlink" title="Báº¯t Ä‘áº§u sá»­ dá»¥ng DVC"></a>Báº¯t Ä‘áº§u sá»­ dá»¥ng DVC</h1><p>Báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u sá»­ dá»¥ng DVC ngay bÃ¢y giá» báº±ng viá»‡c cÃ i Ä‘áº·t theo hÆ°á»›ng dáº«n á»Ÿ link sau: <a href="https://dvc.org/doc/install">https://dvc.org/doc/install</a>.</p><p>Hoáº·c náº¿u báº¡n dÃ¹ng pip, báº¡n cÃ³ thá»ƒ cÃ i Ä‘áº·t DVC báº±ng lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install dvc<br></code></pre></td></tr></table></figure><p>Sau khi cÃ i Ä‘áº·t, trong thÆ° má»¥c chá»©a project repo cá»§a báº¡n, tiáº¿n hÃ nh khá»Ÿi táº¡o project DVC báº±ng lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dvc init<br></code></pre></td></tr></table></figure><h1 id="Lam-quen-voi-quan-ly-phien-ban-du-lieu"><a href="#Lam-quen-voi-quan-ly-phien-ban-du-lieu" class="headerlink" title="LÃ m quen vá»›i quáº£n lÃ½ phiÃªn báº£n dá»¯ liá»‡u"></a>LÃ m quen vá»›i quáº£n lÃ½ phiÃªn báº£n dá»¯ liá»‡u</h1><p>Khi sá»­ dá»¥ng Git vá»›i code, thÃ´ng thÆ°á»ng báº¡n sáº½ thay Ä‘á»•i code trong file rá»“i commit file Ä‘Ã³ vÃ o index cá»§a Git. CÃ¡ch nÃ y phÃ¹ há»£p vá»›i code vÃ¬ cÃ¡c file code thÆ°á»ng cÃ³ kÃ­ch thÆ°á»›c ráº¥t nhá» vÃ  dá»… theo dÃµi nhá»¯ng thay Ä‘á»•i vá» ná»™i dung cá»§a chÃºng.</p><p>KhÃ¡c vá»›i code, dá»¯ liá»‡u thÆ°á»ng cÃ³ kÃ­ch thÆ°á»›c lá»›n vÃ  thay Ä‘á»•i ráº¥t nhiá»u. Náº¿u commit file dá»¯ liá»‡u vÃ o repo, nÃ³ sáº½ trá»Ÿ nÃªn ráº¥t náº·ng. Báº¡n cÅ©ng khÃ´ng thá»ƒ biáº¿t Ä‘Æ°á»£c ráº±ng file dá»¯ liá»‡u nÃ y Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i nhÆ° tháº¿ nÃ o.</p><p>DVC tiáº¿p cáº­n váº¥n Ä‘á» nÃ y báº±ng cÃ¡ch sá»­ dá»¥ng 1 file meta Ä‘á»ƒ lÆ°u láº¡i thÃ´ng tin vá» file dá»¯ liá»‡u. File meta nÃ y cÃ³ kÃ­ch thÆ°á»›c nhá» vÃ  Ä‘Æ°á»£c lÆ°u trá»¯ trong repo cá»§a Git. Khi báº¡n thay Ä‘á»•i file dá»¯ liá»‡u, DVC sáº½ cáº­p nháº­t file meta nÃ y. Khi báº¡n muá»‘n láº¥y láº¡i file dá»¯ liá»‡u, DVC sáº½ dá»±a vÃ o file meta nÃ y Ä‘á»ƒ tÃ¬m ra file dá»¯ liá»‡u cáº§n láº¥y.</p><p>VÃ­ dá»¥, báº¡n cÃ³ 1 file CSV chá»©a dá»¯ liá»‡u training. Báº¡n muá»‘n lÆ°u file nÃ y vÃ o repo cá»§a Git. Báº¡n sáº½ lÃ m nhÆ° sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dvc add train.csv<br></code></pre></td></tr></table></figure><p>Lá»‡nh nÃ y sáº½ táº¡o ra file <code>train.csv.dvc</code> chá»©a thÃ´ng tin meta cá»§a file dá»¯ liá»‡u. Ná»™i dung cá»§a nÃ³ cÃ³ cáº¥u trÃºc giá»‘ng nhÆ° tháº¿ nÃ y:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">outs:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">md5:</span> <span class="hljs-string">9da9c6d8d622f096132838c67e7685b6</span><br>  <span class="hljs-attr">size:</span> <span class="hljs-number">298046</span><br>  <span class="hljs-attr">hash:</span> <span class="hljs-string">md5</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">train.csv</span><br></code></pre></td></tr></table></figure><p>Vá» cÆ¡ báº£n, lá»‡nh <code>dvc add</code> sáº½ tÃ­nh toÃ¡n ra giÃ¡ trá»‹ hash cá»§a file dá»¯ liá»‡u vÃ  lÆ°u vÃ o file <code>train.csv.dvc</code>. HÃ m hash sáº½ Ä‘áº£m báº£o ráº±ng náº¿u file dá»¯ liá»‡u thay Ä‘á»•i thÃ¬ giÃ¡ trá»‹ hash cÅ©ng sáº½ thay Ä‘á»•i.</p><p>Sau khi cÃ³ Ä‘Æ°á»£c file <code>train.csv.dvc</code>, báº¡n commit file nÃ y vÃ o repo cá»§a Git. File nÃ y Ä‘Ã³ng vai trÃ² nhÆ° lÃ  1 con trá», nÃ³ sáº½ trá» tá»›i file dá»¯ liá»‡u tháº­t. File dá»¯ liá»‡u tháº­t sáº½ Ä‘Æ°á»£c lÆ°u trá»¯ trong thÆ° má»¥c <code>.dvc/cache</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git add train.csv.dvc<br>git commit -m <span class="hljs-string">&quot;Add train.csv&quot;</span><br></code></pre></td></tr></table></figure><p>BÃ¢y giá», báº¡n thá»­ edit file <code>train.csv</code> vÃ  lÆ°u láº¡i. Sau Ä‘Ã³, báº¡n cháº¡y lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dvc status<br></code></pre></td></tr></table></figure><p>Lá»‡nh <code>dvc status</code> cÃ³ chá»©c nÄƒng giá»‘ng nhÆ° <code>git status</code> nhÆ°ng dÃ nh cho dá»¯ liá»‡u. Lá»‡nh nÃ y sáº½ kiá»ƒm tra xem file dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i hay chÆ°a. Náº¿u file dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i, lá»‡nh nÃ y sáº½ thÃ´ng bÃ¡o cho báº¡n biáº¿t:</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">train.csv.dvc</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-attribute">changed outs</span><span class="hljs-punctuation">:</span><br>                <span class="hljs-attribute">modified</span><span class="hljs-punctuation">:</span> <span class="hljs-string">          train.csv</span><br></code></pre></td></tr></table></figure><p>VÃ¬ file dá»¯ liá»‡u Ä‘Ã£ thay Ä‘á»•i, file <code>train.csv.dvc</code> khÃ´ng cÃ²n trá» Ä‘áº¿n Ä‘Ãºng file dá»¯ liá»‡u ná»¯a. Báº¡n cáº§n pháº£i update láº¡i file nÃ y báº±ng lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dvc commit train.csv.dvc<br></code></pre></td></tr></table></figure><p>DVC sáº½ há»i lÃ  báº¡n cÃ³ muá»‘n commit file nÃ y hay khÃ´ng. Nháº­p <code>y</code> vÃ  Enter Ä‘á»ƒ tiáº¿p tá»¥c.</p><p>LÃºc nÃ y, DVC sáº½ tÃ­nh toÃ¡n láº¡i giÃ¡ trá»‹ hash cá»§a file dá»¯ liá»‡u vÃ  cáº­p nháº­t láº¡i file <code>train.csv.dvc</code>. Sau Ä‘Ã³, báº¡n commit file vÃ o Git.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git add train.csv.dvc<br>git commit -m <span class="hljs-string">&quot;Update train.csv&quot;</span><br></code></pre></td></tr></table></figure><p>Giáº£ sá»­ nhÆ° báº¡n muá»‘n láº¥y láº¡i file dá»¯ liá»‡u cÅ©. Báº¡n cÃ³ thá»ƒ lÃ m theo cÃ¡ch sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git checkout HEAD~1 -- train.csv.dvc<br>dvc checkout train.csv<br></code></pre></td></tr></table></figure><p>Lá»‡nh <code>git checkout</code> sáº½ láº¥y láº¡i file <code>train.csv.dvc</code> tá»« commit trÆ°á»›c Ä‘Ã³. NhÆ° há»“i nÃ£y mÃ¬nh Ä‘Ã£ nÃ³i, file meta Ä‘Ã³ng vai trÃ² nhÆ° lÃ  1 con trá» Ä‘á»ƒ trá» tá»›i dá»¯ liá»‡u tháº­t. LÃºc nÃ y, file <code>train.csv.dvc</code> khÃ´ng cÃ²n trá» Ä‘áº¿n file <code>train.csv</code> trong thÆ° má»¥c chÃ­nh ná»¯a mÃ  Ä‘ang trá» tá»›i file cÅ© Ä‘ang náº±m trong <code>.dvc/cache</code>.</p><p>Khi tá»›i cÃ¢u lá»‡nh <code>dvc checkout</code>, DVC sáº½ dá»±a vÃ o file meta Ä‘á»ƒ tÃ¬m ra file dá»¯ liá»‡u tháº­t vÃ  Ä‘em file nÃ y vá» thÆ° má»¥c chÃ­nh. Tháº¿ lÃ  báº¡n Ä‘Ã£ láº¥y láº¡i Ä‘Æ°á»£c file dá»¯ liá»‡u cÅ© rá»“i!</p><p>Giá»‘ng nhÆ° Git, DVC cÅ©ng há»— trá»£ lÆ°u trá»¯ remote nhÆ°ng thay vÃ¬ lÃ  Github, Gitlab thÃ¬ ta cÃ³ S3, Google Cloud Storage, Google Drive, HDFS, v.vâ€¦ NhÆ°ng mÃ¬nh sáº½ khÃ´ng Ä‘i sÃ¢u vÃ o pháº§n nÃ y, náº¿u muá»‘n thÃ¬ báº¡n cÃ³ thá»ƒ xem thÃªm táº¡i <a href="https://dvc.org/doc/user-guide/data-management/remote-storage">https://dvc.org/doc/user-guide/data-management/remote-storage</a>.</p><p>NhÆ° váº­y lÃ  mÃ¬nh Ä‘Ã£ cover Ä‘Æ°á»£c khÃ¡i niá»‡m cÆ¡ báº£n vá» quáº£n lÃ½ phiÃªn báº£n dá»¯ liá»‡u cá»§a DVC rá»“i Ä‘áº¥y. Äá»‘i vá»›i mÃ´ hÃ¬nh thÃ¬ vá» cÆ¡ báº£n nÃ³ cÅ©ng chá»‰ lÃ  1 hoáº·c nhiá»u file cÃ³ thá»ƒ Ä‘Æ°á»£c <code>dvc add</code> vÃ  track báº±ng file <code>.dvc</code> mÃ  thÃ´i.</p><p>Äá»£i Ä‘Ã£! NhÆ°ng chÃºng ta chÆ°a giáº£i quyáº¿t Ä‘Æ°á»£c bÃ i toÃ¡n lÃ m tháº¿ nÃ o Ä‘á»ƒ xÃ¡c Ä‘á»‹nh 1 mÃ´ hÃ¬nh Ä‘Æ°á»£c train báº±ng dá»¯ liá»‡u gÃ¬ vÃ  tham sá»‘ nhÆ° tháº¿ nÃ o mÃ , Ä‘Ãºng khÃ´ng???</p><p>Viá»‡c quáº£n lÃ½ phiÃªn báº£n dá»¯ liá»‡u chá»‰ lÃ  bÆ°á»›c khá»Ÿi Ä‘áº§u cho quáº£n lÃ½ phiÃªn báº£n mÃ´ hÃ¬nh. MÃ¬nh sáº½ Ä‘i sÃ¢u hÆ¡n vá» váº¥n Ä‘á» nÃ y trong bÃ i viáº¿t tiáº¿p theo. CÃ²n bÃ¢y giá» thÃ¬ táº¡m thá»i dá»«ng á»Ÿ Ä‘Ã¢y nhÃ© :v.</p><p>Happy Coding!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Machine Learning</tag>
      
      <tag>Artificial Intelligence</tag>
      
      <tag>Data Science</tag>
      
      <tag>Data Version Control</tag>
      
      <tag>Tool</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Quick Note #1: LoRA cho bÃ i toÃ¡n fine-tuning LLM</title>
    <link href="/2023/05/28/Quick-Note-1-LoRA-cho-bai-toan-fine-tuning-LLM/"/>
    <url>/2023/05/28/Quick-Note-1-LoRA-cho-bai-toan-fine-tuning-LLM/</url>
    
    <content type="html"><![CDATA[<h1 id="Low-Rank-Adaptation"><a href="#Low-Rank-Adaptation" class="headerlink" title="Low-Rank Adaptation"></a>Low-Rank Adaptation</h1><ul><li>Pháº§n lá»›n tÃ­nh toÃ¡n trong cÃ¡c mÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n nÃ³i riÃªng vÃ  cÃ¡c mÃ´ hÃ¬nh Deep Learning nÃ³i chung lÃ  nhá»¯ng phÃ©p nhÃ¢n ma tráº­n. Náº¿u tá»‘i Æ°u Ä‘Æ°á»£c quÃ¡ trÃ¬nh nÃ y thÃ¬ sáº½ giáº£m Ä‘Æ°á»£c chi phÃ­ Ä‘Ã¡ng ká»ƒ.</li><li>Báº£n cháº¥t cá»§a quÃ¡ trÃ¬nh fine-tune lÃ  táº¡o ra 1 bá»™ tham sá»‘ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Î”</mi><mi>W</mi></mrow><annotation encoding="application/x-tex">\Delta W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> Ä‘á»ƒ cá»™ng nÃ³ vÃ o <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> - bá»™ tham sá»‘ Ä‘Ã£ Ä‘Æ°á»£c pre-trained - Ä‘á»ƒ táº¡o ra bá»™ tham sá»‘ má»›i <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mo>+</mo><mi mathvariant="normal">Î”</mi><mi>W</mi></mrow><annotation encoding="application/x-tex">W = W_0 + \Delta W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>.</li><li>Giáº£ thuyáº¿t Ä‘Æ°á»£c Ä‘áº·t ra: <strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Î”</mi><mi>W</mi></mrow><annotation encoding="application/x-tex">\Delta W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> lÃ  má»™t ma tráº­n cÃ³ rank (háº¡ng) tháº¥p</strong>.</li><li>Rank cá»§a ma tráº­n cÃ ng nhá» thÃ¬ sá»‘ lÆ°á»£ng tham sá»‘ cáº§n tá»‘i Æ°u cÃ ng Ã­t. Suy ra, cáº§n Ã­t bá»™ nhá»› Ä‘á»ƒ lÆ°u trá»¯ vÃ  tÃ i nguyÃªn Ä‘á»ƒ tÃ­nh toÃ¡n hÆ¡n.</li><li>CÃ´ng thá»©c trÃªn cÃ³ thá»ƒ Ä‘Æ°á»£c biá»ƒu diá»…n láº¡i báº±ng <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mo>+</mo><mi mathvariant="normal">Î”</mi><mi>W</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mo>+</mo><mi>B</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">W = W_0 + \Delta W = W_0 + BA</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Î”</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span> vá»›i <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> vÃ  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> lÃ  2 ma tráº­n cÃ³ sá»‘ chiá»u tháº¥p hÆ¡n nhiá»u so vá»›i <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li><li>VÃ­ dá»¥: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1000</mn><mo>Ã—</mo><mn>1000</mn></mrow></msup></mrow><annotation encoding="application/x-tex">W_0 \in \mathbb{R}^{1000 \times 1000}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mbin mtight">Ã—</span><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1000</mn><mo>Ã—</mo><mn>10</mn></mrow></msup></mrow><annotation encoding="application/x-tex">B \in \mathbb{R}^{1000 \times 10}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mbin mtight">Ã—</span><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>10</mn><mo>Ã—</mo><mn>1000</mn></mrow></msup></mrow><annotation encoding="application/x-tex">A \in \mathbb{R}^{10 \times 1000}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mbin mtight">Ã—</span><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span> thÃ¬ sá»‘ lÆ°á»£ng tham sá»‘ cáº§n tá»‘i Æ°u lÃ  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>Ã—</mo><mn>10</mn><mo>+</mo><mn>10</mn><mo>Ã—</mo><mn>1000</mn><mo>=</mo><mn>20000</mn></mrow><annotation encoding="application/x-tex">1000 \times 10 + 10 \times 1000 = 20000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span> thay vÃ¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>Ã—</mo><mn>1000</mn><mo>=</mo><mn>1000000</mn></mrow><annotation encoding="application/x-tex">1000 \times 1000 = 1000000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span> nhÆ° trÆ°á»›c Ä‘Ã¢y. Tá»©c lÃ  giáº£m Ä‘i 98% sá»‘ lÆ°á»£ng tham sá»‘ cáº§n tá»‘i Æ°u!</li><li>Khi triá»ƒn khai mÃ´ hÃ¬nh LoRA, cáº§n pháº£i táº£i <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> láº«n <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> vÃ  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> vÃ o bá»™ nhá»› vÃ  thá»±c hiá»‡n phÃ©p toÃ¡n <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mo>+</mo><mi>B</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">W = W_0 + BA</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span> Ä‘á»ƒ sinh ra bá»™ tham sá»‘ cho mÃ´ hÃ¬nh Ä‘Ã£ Ä‘Æ°á»£c fine-tune.</li><li>NhÆ°á»£c Ä‘iá»ƒm:<ul><li>Má»—i mÃ´ hÃ¬nh LoRA chá»‰ cÃ³ thá»ƒ xá»­ lÃ½ Ä‘Æ°á»£c 1 tÃ¡c vá»¥ táº¡i 1 thá»i Ä‘iá»ƒm. Khi cáº§n thá»±c hiá»‡n tÃ¡c vá»¥ khÃ¡c thÃ¬ pháº£i thá»±c hiá»‡n chuyá»ƒn Ä‘á»•i bá»™ tham sá»‘.</li><li>Giáº£ sá»­ cÃ³ nhiá»u mÃ´ hÃ¬nh LoRA Ä‘Æ°á»£c triá»ƒn khai, nhÆ°ng chá»‰ cÃ³ 1 instance cá»§a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> Ä‘Æ°á»£c táº£i vÃ o bá»™ nhá»›. Náº¿u dá»¯ liá»‡u Ä‘áº§u vÃ o buá»™c mÃ´ hÃ¬nh pháº£i chuyá»ƒn Ä‘á»•i qua láº¡i giá»¯a cÃ¡c LoRA khÃ¡c nhau thÃ¬ sáº½ lÃ m tÄƒng chi phÃ­ tÃ­nh toÃ¡n vÃ  giáº£m hiá»‡u nÄƒng cá»§a mÃ´ hÃ¬nh.</li></ul></li><li>Giáº£i phÃ¡p: DÃ¹ng <a href="https://arxiv.org/abs/2104.08691">Prompt Tuning</a>.</li></ul><h1 id="Tai-lieu-tham-khao"><a href="#Tai-lieu-tham-khao" class="headerlink" title="TÃ i liá»‡u tham kháº£o"></a>TÃ i liá»‡u tham kháº£o</h1><ul><li><a href="https://arxiv.org/pdf/2106.09685.pdf">LoRA: Low-Rank Adaptation of Large Language Models</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Machine Learning</tag>
      
      <tag>Deep Learning</tag>
      
      <tag>LoRA</tag>
      
      <tag>LLM</tag>
      
      <tag>Artificial Intelligence</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Triá»ƒn khai Triton Inference Server trÃªn Google Kubernetes Engine</title>
    <link href="/2023/01/26/Trien-khai-Triton-Inference-Server-tren-Google-Kubernetes-Engine/"/>
    <url>/2023/01/26/Trien-khai-Triton-Inference-Server-tren-Google-Kubernetes-Engine/</url>
    
    <content type="html"><![CDATA[<h1 id="Tai-sao-can-dung-Triton"><a href="#Tai-sao-can-dung-Triton" class="headerlink" title="Táº¡i sao cáº§n dÃ¹ng Triton?"></a>Táº¡i sao cáº§n dÃ¹ng Triton?</h1><p>Khi triá»ƒn khai mÃ´ hÃ¬nh Deep Learning lÃªn mÃ´i trÆ°á»ng K8S, chÃºng ta cÃ³ thá»ƒ Ã¡p dá»¥ng phÆ°Æ¡ng phÃ¡p giá»‘ng nhÆ° Ä‘á»‘i vá»›i cÃ¡c chÆ°Æ¡ng trÃ¬nh thÃ´ng thÆ°á»ng, vá» cÆ¡ báº£n thÃ¬ sáº½ gá»“m nhá»¯ng bÆ°á»›c nhÆ° sau:</p><ol><li>ÄÃ³ng gÃ³i code vÃ  mÃ´ hÃ¬nh vÃ o Docker image.</li><li>Äáº©y image lÃªn registry.</li><li>Táº¡o deployment vÃ  service trÃªn K8S.</li><li>Táº¡o ingress ná»‘i Ä‘áº¿n service vá»«a táº¡o.</li></ol><p>PhÆ°Æ¡ng phÃ¡p nÃ y ráº¥t Ä‘Æ¡n giáº£n vÃ  hiá»‡u quáº£ Ä‘á»‘i vá»›i nhá»¯ng mÃ´ hÃ¬nh gá»n nháº¹ khÃ´ng cáº§n Ä‘áº¿n GPU, vÃ­ dá»¥ nhÆ° mÃ´ hÃ¬nh phÃ¢n loáº¡i vÄƒn báº£n báº±ng LSTM, cÃ¡c mÃ´ hÃ¬nh Machine Learning truyá»n thá»‘ng nhÆ° SVM hay Random Forest. NhÆ°ng khi mÃ´ hÃ¬nh lá»›n Ä‘áº¿n má»©c khÃ´ng Ä‘Ã¡p á»©ng Ä‘Æ°á»£c cÃ¡c yÃªu cáº§u vá» latency hoáº·c throughput thÃ¬ triá»ƒn khai lÃªn GPU lÃ  Ä‘iá»u cáº§n thiáº¿t. Náº¿u chÃºng ta váº«n Ã¡p dá»¥ng phÆ°Æ¡ng phÃ¡p ká»ƒ trÃªn thÃ¬ cÃ³ nhá»¯ng nhÆ°á»£c Ä‘iá»ƒm nhÆ° sau:</p><ol><li>CÃ¡c image dÃ¹ng Ä‘Æ°á»£c GPU thÆ°á»ng cÃ³ kÃ­ch thÆ°á»›c lá»›n, cá»™ng vá»›i viá»‡c mÃ´ hÃ¬nh cÅ©ng cÃ³ kÃ­ch thÆ°á»›c lá»›n khiáº¿n cho <strong>image Ä‘áº§u ra náº·ng Ä‘áº¿n má»©c lÃ m cháº­m Ä‘Ã¡ng ká»ƒ thá»i gian push vÃ  pull image trong quÃ¡ trÃ¬nh triá»ƒn khai</strong>. Äiá»u nÃ y gÃ¢y khÃ³ khÄƒn náº¿u mÃ´ hÃ¬nh thÆ°á»ng xuyÃªn Ä‘Æ°á»£c cáº­p nháº­t vá»›i dá»¯ liá»‡u má»›i.</li><li><strong>Kubernetes khÃ´ng cung cáº¥p cÆ¡ cháº¿ native cho viá»‡c cáº¥p phÃ¡t 1 GPU cho nhiá»u container</strong>. KhÃ´ng giá»‘ng nhÆ° khi cáº¥p phÃ¡t CPU, container khi yÃªu cáº§u K8S cáº¥p phÃ¡t GPU chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c cáº¥p nguyÃªn cáº£ 1 GPU chá»© khÃ´ng Ä‘Æ°á»£c yÃªu cáº§u 0.5 hay 0.1 GPU. Váº¥n Ä‘á» nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c kháº¯c phá»¥c nhá» vÃ o má»™t sá»‘ giáº£i phÃ¡p nhÆ° <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/gpus-multi">multi-instance GPUs</a> (chá»‰ há»— trá»£ dÃ²ng A100) hoáº·c <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/timesharing-gpus">time-sharing GPUs</a>, nhÆ°ng Ä‘á»u pháº£i phá»¥ thuá»™c vÃ o giáº£i phÃ¡p cá»§a bÃªn thá»© 3, Ä‘á»“ng nghÄ©a vá»›i viá»‡c migrate sáº½ phá»©c táº¡p hÆ¡n (giáº£ sá»­ nhÆ° báº¡n muá»‘n chuyá»ƒn qua AWS nhÆ°ng há» chÆ°a há»— trá»£ hoáº·c cung cáº¥p giáº£i phÃ¡p khÃ¡c thÃ¬ sao?).</li></ol><p><a href="https://github.com/triton-inference-server/server">Triton</a> cÃ³ thá»ƒ giáº£i quyáº¿t Ä‘Æ°á»£c nhá»¯ng nhÆ°á»£c Ä‘iá»ƒm nÃ y. NÃ³ lÃ  1 pháº§n má»m mÃ£ nguá»“n má»Ÿ dÃ nh cho vai trÃ² inference cÃ¡c mÃ´ hÃ¬nh Machine Learning, Ä‘Æ°á»£c táº¡o bá»Ÿi Ä‘á»™i ngÅ© cá»§a Nvidia. Triton cho phÃ©p triá»ƒn khai nhiá»u mÃ´ hÃ¬nh Ä‘áº¿n tá»« nhiá»u framework khÃ¡c nhau, bao gá»“m TensorRT, TensorFlow, PyTorch, ONNX, OpenVINO, Python, RAPIDS FIL,â€¦ Triton há»— trá»£ nhiá»u hÃ¬nh thá»©c truy váº¥n khÃ¡c nhau, bao gá»“m truy váº¥n real time, theo batched, ensembles, vÃ  audio/video streaming. ChÃºng Ä‘á»u Ä‘Æ°á»£c tá»‘i Æ°u Ä‘á»ƒ cÃ³ hiá»‡u nÄƒng cao.</p><p>Váº­y thÃ¬ Triton giáº£i quyáº¿t nhá»¯ng váº¥n Ä‘á» trÃªn nhÆ° tháº¿ nÃ o?</p><ol><li>Khi triá»ƒn khai Triton lÃªn K8S, chÃºng ta khÃ´ng cáº§n pháº£i Ä‘Ã³ng gÃ³i image kÃ¨m vá»›i mÃ´ hÃ¬nh. Thay vÃ o Ä‘Ã³, mÃ´ hÃ¬nh Ä‘Æ°á»£c mount tá»« 1 file system vÃ o 1 thÆ° má»¥c cá»¥ thá»ƒ, hoáº·c káº¿t ná»‘i Ä‘áº¿n cloud storage nhÆ° S3 hay GCS. Khi khá»Ÿi Ä‘á»™ng, Triton sáº½ táº£i mÃ´ hÃ¬nh tá»« cloud storage vá» local vÃ  báº¯t Ä‘áº§u cháº¡y. VÃ¬ tháº¿ nÃªn kÃ­ch thÆ°á»›c cá»§a image sáº½ nháº¹ hÆ¡n vÃ  khÃ´ng cáº§n pháº£i pull láº¡i image khi cáº­p nháº­t mÃ´ hÃ¬nh mÃ  chá»‰ cáº§n táº£i láº¡i file mÃ´ hÃ¬nh tá»« cloud storage.</li><li>CÆ¡ cháº¿ cá»§a Triton lÃ  quáº£n lÃ½ táº­p trung nhiá»u mÃ´ hÃ¬nh khÃ¡c nhau trong cÃ¹ng 1 container. Trong Ä‘Ã³, cÃ¡c mÃ´ hÃ¬nh cÃ³ thá»ƒ cÃ¹ng chia sáº» tÃ i nguyÃªn cá»§a 1 GPU, giÃºp cho viá»‡c sá»­ dá»¥ng GPU tá»‘i Æ°u hÆ¡n. Giáº£i phÃ¡p cá»§a bÃªn thá»© 3 vÃ¬ váº­y trá»Ÿ nÃªn khÃ´ng cáº§n thiáº¿t nÃªn viá»‡c migrate sáº½ dá»… dÃ ng hÆ¡n.</li></ol><p>Trong pháº§n tiáº¿p theo, mÃ¬nh sáº½ hÆ°á»›ng dáº«n cÃ¡ch triá»ƒn khai Triton trÃªn Google Kubernetes Engine.</p><h1 id="Trien-khai-Triton-tren-GKE"><a href="#Trien-khai-Triton-tren-GKE" class="headerlink" title="Triá»ƒn khai Triton trÃªn GKE"></a>Triá»ƒn khai Triton trÃªn GKE</h1><p>TrÆ°á»›c khi báº¯t Ä‘áº§u triá»ƒn khai, chÃºng ta hÃ£y cÃ¹ng phÃ¢n tÃ­ch kiáº¿n trÃºc cá»§a Triton trÃªn GKE.</p><h2 id="Kien-truc-tong-quan"><a href="#Kien-truc-tong-quan" class="headerlink" title="Kiáº¿n trÃºc tá»•ng quan"></a>Kiáº¿n trÃºc tá»•ng quan</h2><p><img src="/2023/01/26/Trien-khai-Triton-Inference-Server-tren-Google-Kubernetes-Engine/triton-architecture.jpg" alt="Kiáº¿n trÃºc tá»•ng quan cá»§a Triton trÃªn GKE"></p><p>NhÆ° Ä‘Ã£ nÃ³i á»Ÿ pháº§n trÆ°á»›c, Triton cáº§n pháº£i mount tá»« 1 file system hoáº·c cloud storage Ä‘á»ƒ cÃ³ thá»ƒ táº£i mÃ´ hÃ¬nh lÃªn GPU. GKE Ä‘á»u cung cáº¥p cáº£ 2 cÃ¡ch mount nÃ y, nhÆ°ng mount tá»« file system sáº½ gÃ¢y khÃ³ khÄƒn trong viá»‡c táº£i mÃ´ hÃ¬nh lÃªn disk trong khi Ä‘Ã³ thÃ¬ GCS cho phÃ©p táº£i, chá»‰nh sá»­a, xoÃ¡ file má»™t cÃ¡ch dá»… dÃ ng. HÆ¡n ná»¯a lÃ  chi phÃ­ cá»§a GCS ráº» hÆ¡n so vá»›i dÃ¹ng disk, GCS tÃ­nh phÃ­ theo phÆ°Æ¡ng Ã¡n â€œdÃ¹ng nhiÃªu tráº£ nhiÃªuâ€, cÃ²n disk thÃ¬ ta pháº£i cáº¥p phÃ¡t lÆ°á»£ng dung lÆ°á»£ng nháº¥t Ä‘á»‹nh khÃ´ng trÃ¡nh khá»i dÆ° thá»«a.</p><p>Máº·c dÃ¹ Triton cho phÃ©p cháº¡y custom code Python Ä‘á»ƒ preprocess input vÃ  postprocess output, giÃºp cho nÃ³ cÃ³ thá»ƒ xá»­ lÃ½ request tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i. NhÆ°ng theo mÃ¬nh thÃ¬ Triton chá»‰ nÃªn Ä‘Æ°á»£c sá»­ dá»¥ng cho má»¥c Ä‘Ã­ch inference mÃ´ hÃ¬nh mÃ  thÃ´i. CÃ¡c cÃ´ng Ä‘oáº¡n nhÆ° preprocess, postprocess, monitor nÃªn Ä‘Æ°á»£c giao cho pod khÃ¡c mÃ  mÃ¬nh gá»i lÃ  API Service trong hÃ¬nh trÃªn. NhÆ° tháº¿ sáº½ tÃ¡ch rá»i Ä‘Æ°á»£c vai trÃ² giá»¯a cÃ¡c service, theo nguyÃªn táº¯c thiáº¿t káº¿ cá»§a microservice.</p><p>API Service lÃ  nÆ¡i nháº­n request tá»« bÃªn ngoÃ i, preprocess, gá»­i data Ä‘áº¿n Triton, nháº­n káº¿t quáº£ inference, postprocess vÃ  tráº£ káº¿t quáº£ vá». NÃ³ cÃ²n cÃ³ nhiá»‡m vá»¥ theo dÃµi cÃ¡c metric nhÆ° latency, request per second, throughput, confident score. Má»™t lá»£i Ã­ch khÃ¡c cá»§a viá»‡c phÃ¢n tÃ¡ch vai trÃ² lÃ  cÃ³ thá»ƒ scale má»™t cÃ¡ch linh hoáº¡t hÆ¡n. Giáº£ sá»­ nhÆ° báº¡n cÃ³ 1 module preprocess ráº¥t náº·ng vÃ  cháº­m, báº¡n cÃ³ thá»ƒ scale pod API Service trÃªn 1 node khÃ¡c khÃ´ng cáº§n GPU nhÆ°ng cÃ³ nhiá»u tÃ i nguyÃªn hÆ¡n mÃ  khÃ´ng cáº§n pháº£i scale luÃ´n cáº£ Triton.</p><h2 id="Tien-hanh-trien-khai"><a href="#Tien-hanh-trien-khai" class="headerlink" title="Tiáº¿n hÃ nh triá»ƒn khai"></a>Tiáº¿n hÃ nh triá»ƒn khai</h2><h3 id="Tao-GCS-bucket"><a href="#Tao-GCS-bucket" class="headerlink" title="Táº¡o GCS bucket"></a>Táº¡o GCS bucket</h3><p>Viá»‡c Ä‘áº§u tiÃªn chÃºng ta cáº§n pháº£i lÃ m lÃ  táº¡o 1 bucket trÃªn GCS. Náº¿u báº¡n Ä‘Ã£ cÃ³ sáºµn bucket rá»“i thÃ¬ cÃ³ thá»ƒ bá» qua pháº§n nÃ y.</p><ol><li>Trong pháº§n navigation, chá»n <strong>Cloud Storage</strong> &gt; <strong>Buckets</strong>.</li><li>Click <strong>Create</strong>.</li><li>Chá»n tÃªn cho bucket. Trong bÃ i viáº¿t nÃ y mÃ¬nh sáº½ giáº£ sá»­ tÃªn cá»§a bucket lÃ  <strong>triton-models</strong>, nhÆ°ng báº¡n nÃªn chá»n tÃªn khÃ¡c vÃ¬ tÃªn bucket lÃ  globally unique. Trong cÃ¡c Ä‘oáº¡n code bÃªn dÆ°á»›i, báº¡n cáº§n thay tÃªn bucket giáº£ sá»­ vá»›i tÃªn bucket mÃ  báº¡n táº¡o.</li><li>Trong má»¥c control access, mÃ¬nh recommend báº¡n hÃ£y giá»›i háº¡n quyá»n truy cáº­p vÃ o bucket nÃ y báº±ng cÃ¡ch check vÃ o Ã´ <strong>Enforce public access prevention on this bucket</strong>. NÃ³ sáº½ ngÄƒn model bá»‹ public ra bÃªn ngoÃ i.</li><li>Click <strong>Create</strong>.</li></ol><p><img src="/2023/01/26/Trien-khai-Triton-Inference-Server-tren-Google-Kubernetes-Engine/screenshot-1.jpeg" alt="Táº¡o GCS bucket"></p><h3 id="Tao-service-account"><a href="#Tao-service-account" class="headerlink" title="Táº¡o service account"></a>Táº¡o service account</h3><p>Äá»ƒ Triton cÃ³ thá»ƒ truy cáº­p vÃ o bucket cá»§a GCS, chÃºng ta pháº£i cung cáº¥p cho nÃ³ key cá»§a service account cÃ³ quyá»n truy cáº­p vÃ o GCS. Äá»ƒ lÃ m Ä‘iá»u nÃ y, trÆ°á»›c tiÃªn ta pháº£i táº¡o service account cÃ³ quyá»n <strong>Storage Admin</strong>. ChÃº Ã½ lÃ  chá»‰ nÃªn cáº¥p 1 quyá»n nÃ y cho service account cá»§a báº¡n Ä‘á»ƒ giáº£m thiá»ƒu rá»§i ro an ninh.</p><ol><li>Truy cáº­p vÃ o <strong>IAM &amp; Admin</strong> &gt; <strong>Service Accounts</strong>.</li><li>Click <strong>CREATE SERVICE ACCOUNT</strong>.</li><li>Äiá»n cÃ¡c thÃ´ng tin cáº§n thiáº¿t.</li><li>Äáº¿n pháº§n <strong>Grant this service account access to project</strong>, thÃªm quyá»n <strong>Storage Admin</strong>.</li><li>Click <strong>Done</strong>.</li></ol><p>Náº¿u báº¡n khÃ´ng cÃ³ quyá»n Ä‘á»ƒ truy cáº­p <strong>IAM &amp; Admin</strong> &gt; <strong>Service Accounts</strong>, báº¡n cÃ³ thá»ƒ nhá» admin cá»§a project Ä‘á»ƒ táº¡o thay.</p><p><img src="/2023/01/26/Trien-khai-Triton-Inference-Server-tren-Google-Kubernetes-Engine/screenshot-2.jpeg" alt="Táº¡o service account"></p><p>Sau khi táº¡o xong service account, báº¡n chá»n service account vá»«a táº¡o vÃ  chá»n tab <strong>KEYS</strong>. á» Ä‘Ã¢y liá»‡t kÃª cÃ¡c key dÃ¹ng Ä‘á»ƒ authenticate vá»›i quyá»n cá»§a service account nÃ y, click vÃ o <strong>ADD KEY</strong> vÃ  chá»n <strong>Create new key</strong>, chá»n key type lÃ  JSON vÃ  click <strong>CREATE</strong>.</p><p><img src="/2023/01/26/Trien-khai-Triton-Inference-Server-tren-Google-Kubernetes-Engine/screenshot-3.jpeg" alt="Táº¡o key cá»§a service account"></p><p>Táº£i file key vá»›i tÃªn lÃ  <code>key.json</code> vá» mÃ´i trÆ°á»ng kubectl cá»§a báº¡n vÃ  dÃ¹ng lá»‡nh sau Ä‘á»ƒ táº¡o secret trÃªn K8S:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create secret generic triton-service-account --from-file=key.json=./key.json<br></code></pre></td></tr></table></figure><p>Secret nÃ y sáº½ Ä‘Æ°á»£c mount vÃ o container cá»§a Triton Ä‘á»ƒ authenticate vá»›i GCS.</p><h3 id="Trien-khai-Triton"><a href="#Trien-khai-Triton" class="headerlink" title="Triá»ƒn khai Triton"></a>Triá»ƒn khai Triton</h3><p>DÆ°á»›i Ä‘Ã¢y lÃ  cáº¥u hÃ¬nh deployment cá»§a Triton:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">triton</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">triton</span><br>    <span class="hljs-attr">app.kubernetes.io/instance:</span> <span class="hljs-string">triton</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">triton</span><br>      <span class="hljs-attr">app.kubernetes.io/instance:</span> <span class="hljs-string">triton</span><br>  <span class="hljs-comment"># Loáº¡i bá» Ä‘oáº¡n nÃ y náº¿u báº¡n cÃ³ nhiá»u hÆ¡n 1 GPU.</span><br>  <span class="hljs-comment"># Äoáº¡n nÃ y cÃ³ tÃ¡c dá»¥ng ngÄƒn tÃ¬nh tráº¡ng khÃ´ng thá»ƒ táº¡o pod má»›i thay tháº¿ pod cÅ© khi chá»‰ cÃ³ 1 GPU.</span><br>  <span class="hljs-attr">strategy:</span><br>    <span class="hljs-attr">rollingUpdate:</span><br>      <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">triton</span><br>        <span class="hljs-attr">app.kubernetes.io/instance:</span> <span class="hljs-string">triton</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">triton</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nvcr.io/nvidia/tritonserver:22.12-py3</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">tritonserver</span><br>        <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">--model-repository=gs://triton-models/</span><br>        <span class="hljs-comment"># Mount service account key vÃ o thÆ° má»¥c /var/secrets/google</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/secrets/google</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">google-cloud-key</span><br>        <span class="hljs-comment"># Chá»‰ Ä‘á»‹nh vá»‹ trÃ­ cá»§a service account key cho Triton</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GOOGLE_APPLICATION_CREDENTIALS</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">/var/secrets/google/key.json</span><br>        <span class="hljs-comment"># CÃ¡c port cá»§a Triton</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8000</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">grpc</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8001</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8002</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-comment"># Báº¯t buá»™c pháº£i khai bÃ¡o cáº¥p phÃ¡t GPU Ä‘á»ƒ Ä‘Æ°á»£c cáº¥p</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-string">&quot;1&quot;</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-string">&quot;1&quot;</span><br>      <span class="hljs-comment"># DÃ¹ng secret vá»«a táº¡o á»Ÿ bÆ°á»›c trÃªn Ä‘á»ƒ táº¡o thÃ nh volume mount</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">google-cloud-key</span><br>          <span class="hljs-attr">secret:</span><br>            <span class="hljs-attr">secretName:</span> <span class="hljs-string">triton-service-account</span><br></code></pre></td></tr></table></figure><p>Copy Ä‘oáº¡n code trÃªn vÃ o file <code>deployment.yaml</code> vÃ  cháº¡y lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f deployment.yaml<br></code></pre></td></tr></table></figure><p>Tiáº¿p theo lÃ  táº¡o file service <code>service.yaml</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">triton</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">triton</span><br>    <span class="hljs-attr">app.kubernetes.io/instance:</span> <span class="hljs-string">triton</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GRPC</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-string">grpc</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">HTTP</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8000</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">triton</span><br>    <span class="hljs-attr">app.kubernetes.io/instance:</span> <span class="hljs-string">triton</span><br></code></pre></td></tr></table></figure><p>Táº¡o service báº±ng lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f service.yaml<br></code></pre></td></tr></table></figure><p>Sau khi hoÃ n táº¥t, báº¡n cÃ³ thá»ƒ gá»i service triton tá»« cÃ¡c pod khÃ¡c trong cluster thÃ´ng qua endpoint <code>triton:8000</code> Ä‘á»‘i vá»›i HTTP hoáº·c <code>triton:8001</code> Ä‘á»‘i vá»›i GRPC.</p><p>Náº¿u muá»‘n gá»i trá»±c tiáº¿p Triton tá»« ngoÃ i cluster thÃ¬ báº¡n cÃ³ thá»ƒ táº¡o file <code>ingress.yaml</code>, náº¿u dÃ¹ng NGINX Ingress Controller thÃ¬ file cáº¥u hÃ¬nh cÆ¡ báº£n sáº½ tÆ°Æ¡ng tá»± nhÆ° sau:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">triton</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/$2</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ingressClassName:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">rules:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">&lt;your-domain&gt;</span><br>      <span class="hljs-attr">http:</span><br>        <span class="hljs-attr">paths:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/triton(/|$)(.*)</span><br>            <span class="hljs-attr">backend:</span><br>              <span class="hljs-attr">service:</span><br>                <span class="hljs-attr">name:</span> <span class="hljs-string">triton</span><br>                <span class="hljs-attr">port:</span><br>                  <span class="hljs-attr">number:</span> <span class="hljs-number">8000</span><br></code></pre></td></tr></table></figure><p>Rá»“i dÃ¹ng lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f ingress.yaml<br></code></pre></td></tr></table></figure><p>Ingress nÃ y sáº½ Ä‘iá»u hÆ°á»›ng request URL cÃ³ prefix dáº¡ng <code>http://&lt;your-domain&gt;/triton</code> Ä‘áº¿n service triton vÃ o port HTTP.</p><h3 id="Chay-mo-hinh"><a href="#Chay-mo-hinh" class="headerlink" title="Cháº¡y mÃ´ hÃ¬nh"></a>Cháº¡y mÃ´ hÃ¬nh</h3><p>Do bucket vá»«a má»›i táº¡o chÆ°a cÃ³ gÃ¬ nÃªn chÃºng ta chÆ°a thá»ƒ cháº¡y Ä‘Æ°á»£c mÃ´ hÃ¬nh nÃ o cáº£. TrÆ°á»›c tiÃªn, báº¡n cáº§n Ä‘Æ°a mÃ´ hÃ¬nh cá»§a báº¡n lÃªn bucket theo Ä‘Ãºng chuáº©n do Triton quy Ä‘á»‹nh, tham kháº£o á»Ÿ <a href="https://github.com/triton-inference-server/server/blob/main/docs/user_guide/model_repository.md">Ä‘Ã¢y</a>. Äá»ƒ diá»…n giáº£i cho pháº§n nÃ y, mÃ¬nh giáº£ sá»­ á»Ÿ Ä‘Ã¢y Ä‘ang cÃ³ 1 mÃ´ hÃ¬nh BERT cho bÃ i toÃ¡n phÃ¢n loáº¡i vÄƒn báº£n.</p><p>Náº¿u báº¡n Ä‘Ã£ Ä‘á»c document tham kháº£o cá»§a Triton, hÃ£y thá»­ xem qua file config cá»§a BERT:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs text">name: &quot;bert_text_classification&quot;<br>platform: &quot;onnxruntime_onnx&quot;<br>max_batch_size: 0<br>input [<br>  &#123;<br>    name: &quot;input_ids&quot;<br>    data_type: TYPE_INT32<br>    dims: [-1, -1]<br>  &#125;,<br>  &#123;<br>    name: &quot;attention_mask&quot;<br>    data_type: TYPE_INT32<br>    dims: [-1, -1]<br>  &#125;<br>]<br><br>output [<br>  &#123;<br>    name: &quot;logits&quot;<br>    data_type: TYPE_FP32<br>    dims: [-1, 2]<br>  &#125;<br>]<br><br>instance_group [<br>  &#123;<br>    count: 1<br>    kind: KIND_GPU<br>  &#125;<br>]<br></code></pre></td></tr></table></figure><p>Äá»ƒ giao tiáº¿p vá»›i Triton, cÃ³ 2 protocol lÃ  HTTP vÃ  gRPC. gRPC cÃ³ hiá»‡u suáº¥t tá»‘t hÆ¡n so vá»›i HTTP nÃªn mÃ¬nh chá»n protocol nÃ y cho code API Service. Triton cung cáº¥p cho chÃºng ta thÆ° viá»‡n Python Ä‘á»ƒ Ä‘Æ¡n giáº£n hoÃ¡ viá»‡c gá»i mÃ´ hÃ¬nh (<a href="https://github.com/triton-inference-server/client">Github</a>).</p><p>DÆ°á»›i Ä‘Ã¢y lÃ  Ä‘oáº¡n code tham kháº£o Ä‘á»ƒ gá»i mÃ´ hÃ¬nh BERT cho text classification:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> math<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> scipy.special<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br><span class="hljs-keyword">import</span> tritonclient.grpc <span class="hljs-keyword">as</span> grpcclient<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Predictor</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,</span><br><span class="hljs-params">                 model_name: <span class="hljs-built_in">str</span>,</span><br><span class="hljs-params">                 tokenizer: AutoTokenizer,</span><br><span class="hljs-params">                 triton_url: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;triton:8001&#x27;</span>,</span><br><span class="hljs-params">                 batch_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">64</span></span>):<br>        self.model_name = model_name<br>        self.tokenizer = tokenizer<br>        self.triton_url = triton_url<br>        self.batch_size = batch_size<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_batch</span>(<span class="hljs-params">self, batch_items: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):<br>        <span class="hljs-comment"># Tokenize &amp; encode</span><br>        inputs = self.tokenizer.batch_encode_plus(batch_items,<br>                                                  add_special_tokens=<span class="hljs-literal">True</span>,<br>                                                  max_length=<span class="hljs-number">256</span>,<br>                                                  truncation=<span class="hljs-literal">True</span>,<br>                                                  pad_to_max_length=<span class="hljs-literal">True</span>)<br>        input_ids = np.array(inputs[<span class="hljs-string">&#x27;input_ids&#x27;</span>]).astype(np.int32)<br>        attention_mask = np.array(inputs[<span class="hljs-string">&#x27;attention_mask&#x27;</span>]).astype(np.int32)<br><br>        <span class="hljs-comment"># Setup inference</span><br>        triton_client = grpcclient.InferenceServerClient(url=self.triton_url, verbose=<span class="hljs-literal">False</span>)<br>        outputs = [grpcclient.InferRequestedOutput(<span class="hljs-string">&#x27;logits&#x27;</span>)]<br>        y_pred = []<br>        n_batches = math.ceil(<span class="hljs-built_in">len</span>(batch_items) / self.batch_size)<br><br>        <span class="hljs-comment"># Infer in batches</span><br>        <span class="hljs-keyword">for</span> x0, x1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(np.array_split(input_ids, n_batches),<br>                          np.array_split(attention_mask, n_batches)):<br>            inputs = [<br>                grpcclient.InferInput(<span class="hljs-string">&#x27;input_ids&#x27;</span>, x0.shape, <span class="hljs-string">&#x27;INT32&#x27;</span>),<br>                grpcclient.InferInput(<span class="hljs-string">&#x27;attention_mask&#x27;</span>, x1.shape, <span class="hljs-string">&#x27;INT32&#x27;</span>),<br>            ]<br><br>            inputs[<span class="hljs-number">0</span>].set_data_from_numpy(x0)<br>            inputs[<span class="hljs-number">1</span>].set_data_from_numpy(x1)<br><br>            results = triton_client.infer(<br>                model_name=self.model_name,<br>                inputs=inputs,<br>                outputs=outputs)<br><br>            logits = results.as_numpy(<span class="hljs-string">&#x27;logits&#x27;</span>)<br>            output_prob = scipy.special.softmax(logits, axis=<span class="hljs-number">1</span>)<br>            y_pred.extend(output_prob.tolist())<br><br>        <span class="hljs-keyword">return</span> y_pred<br></code></pre></td></tr></table></figure><p>Äoáº¡n code nÃ y chá»‰ lÃ  pháº§n core cá»§a API Service, nhá»¯ng thÃ nh pháº§n khÃ¡c nhÆ° server, text preprocess, postprocess thÃ¬ báº¡n tham kháº£o á»Ÿ bÃªn ngoÃ i nhÃ©.</p><h1 id="Cac-van-de-nay-sinh"><a href="#Cac-van-de-nay-sinh" class="headerlink" title="CÃ¡c váº¥n Ä‘á» náº£y sinh"></a>CÃ¡c váº¥n Ä‘á» náº£y sinh</h1><h2 id="Kich-thuoc-image-con-kha-lon"><a href="#Kich-thuoc-image-con-kha-lon" class="headerlink" title="KÃ­ch thÆ°á»›c image cÃ²n khÃ¡ lá»›n"></a>KÃ­ch thÆ°á»›c image cÃ²n khÃ¡ lá»›n</h2><p>Náº¿u báº¡n dÃ¹ng spot node nhÆ° mÃ¬nh thÃ¬ hay xáº£y ra trÆ°á»ng há»£p bá»‹ downtime khÃ¡ lÃ¢u khi node bá»‹ preemptible. NguyÃªn nhÃ¢n chá»§ yáº¿u lÃ  do image cá»§a Triton váº«n cÃ²n khÃ¡ náº·ng nÃªn thá»i gian pull vá» lÃ¢u. CÃ³ thá»ƒ giáº£m kÃ­ch thÆ°á»›c cá»§a image báº±ng cÃ¡ch build custom image chá»‰ há»— trá»£ framework mÃ  báº¡n hay dÃ¹ng, nhÆ° cá»§a mÃ¬nh lÃ  ONNX nÃªn cÃ³ thá»ƒ loáº¡i bá» TF, PyTorch. Xem á»Ÿ <a href="https://github.com/triton-inference-server/server/blob/main/docs/customization_guide/compose.md">Ä‘Ã¢y</a> Ä‘á»ƒ tham kháº£o cÃ¡ch build custom image cho framework cá»§a báº¡n.</p><h2 id="Tranh-chap-tai-nguyen-giua-cac-mo-hinh"><a href="#Tranh-chap-tai-nguyen-giua-cac-mo-hinh" class="headerlink" title="Tranh cháº¥p tÃ i nguyÃªn giá»¯a cÃ¡c mÃ´ hÃ¬nh"></a>Tranh cháº¥p tÃ i nguyÃªn giá»¯a cÃ¡c mÃ´ hÃ¬nh</h2><p>Hiá»‡n táº¡i chÆ°a cÃ³ cÆ¡ cháº¿ giá»›i háº¡n tÃ i nguyÃªn cá»§a mÃ´ hÃ¬nh nÃªn náº¿u cÃ³ 1 mÃ´ hÃ¬nh sá»­ dá»¥ng háº¿t tÃ i nguyÃªn cá»§a GPU thÃ¬ cÃ¡c mÃ´ hÃ¬nh khÃ¡c sáº½ khÃ´ng thá»ƒ cháº¡y Ä‘Æ°á»£c. </p><h2 id="Kho-scale-theo-chieu-ngang"><a href="#Kho-scale-theo-chieu-ngang" class="headerlink" title="KhÃ³ scale theo chiá»u ngang"></a>KhÃ³ scale theo chiá»u ngang</h2><p>VÃ¬ Triton quáº£n lÃ½ mÃ´ hÃ¬nh theo hÃ¬nh thá»©c táº­p trung, má»—i pod sáº½ chá»©a Ã­t nháº¥t 1 instance cá»§a má»—i mÃ´ hÃ¬nh. Khi ta muá»‘n scale 1 mÃ´ hÃ¬nh, náº¿u ta scale sá»‘ lÆ°á»£ng pod thÃ¬ Ä‘á»“ng nghÄ©a vá»›i viá»‡c scale táº¥t cáº£ mÃ´ hÃ¬nh cÃ²n láº¡i, ráº¥t lÃ  lÃ£ng phÃ­. Äá»‘i vá»›i scale theo chiá»u dá»c thÃ¬ sáº½ dá»… dÃ ng hÆ¡n vÃ¬ Triton cho phÃ©p táº¡o nhiá»u instance cá»§a 1 mÃ´ hÃ¬nh trÃªn nhiá»u GPU, xem <a href="https://github.com/triton-inference-server/server/blob/main/docs/user_guide/model_configuration.md#instance-groups">Instance Groups</a>.</p><h1 id="Tong-ket"><a href="#Tong-ket" class="headerlink" title="Tá»•ng káº¿t"></a>Tá»•ng káº¿t</h1><p>Hi vá»ng sau bÃ i viáº¿t nÃ y, báº¡n cÃ³ thá»ƒ triá»ƒn khai mÃ´ hÃ¬nh cá»§a mÃ¬nh lÃªn Triton trÃªn GKE. Máº·c dÃ¹ bÃ i viáº¿t nÃ y chá»‰ táº­p trung vÃ o GKE, náº¿u báº¡n dÃ¹ng AWS hay onprem thÃ¬ cÆ¡ cháº¿ cÅ©ng gáº§n tÆ°Æ¡ng tá»± nhau, chá»‰ cáº§n 1 cloud storage giá»‘ng nhÆ° S3 hoáº·c GCS lÃ  cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c, vÃ  táº¥t nhiÃªn lÃ  cáº§n GPU ná»¯a.</p><p>Happy Coding!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Machine Learning</tag>
      
      <tag>Deep Learning</tag>
      
      <tag>Artificial Intelligence</tag>
      
      <tag>K8S</tag>
      
      <tag>Triton Inference Server</tag>
      
      <tag>Google Kubernetes Engine</tag>
      
      <tag>MLOps</tag>
      
      <tag>Model Serving</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Triá»ƒn khai GPT-J 6B Vietnamese News trÃªn Docker vÃ  K8S</title>
    <link href="/2022/12/28/Trien-khai-GPT-J-6B-Vietnamese-News-tren-Docker-va-K8S/"/>
    <url>/2022/12/28/Trien-khai-GPT-J-6B-Vietnamese-News-tren-Docker-va-K8S/</url>
    
    <content type="html"><![CDATA[<p>Thá»i gian gáº§n Ä‘Ã¢y Ä‘ang ná»•i lÃªn 1 con AI tÃªn lÃ  ChatGPT cÃ³ kháº£ nÄƒng giao tiáº¿p nhÆ° ngÆ°á»i tháº­t, biáº¿t lÃ m thÆ¡, viáº¿t luáº­n vÄƒn, giáº£i toÃ¡n, dá»‹ch tiáº¿ng Anh sang tiáº¿ng Viá»‡t, ngay cáº£ viáº¿t vÃ  Ä‘á»c hiá»ƒu code. Tháº­m chÃ­ nÃ³ cÃ³ thá»ƒ â€œgiáº£ láº­pâ€ mÃ¡y áº£o linux vÃ  â€œchat vá»›i 1 ChatGPT khÃ¡c trong mÃ¡y áº£o Ä‘Ã³â€ (Äá»c thÃªm á»Ÿ <a href="https://www.engraved.blog/building-a-virtual-machine-inside/">Ä‘Ã¢y</a>). Báº£n cháº¥t bÃªn dÆ°á»›i cá»§a há»‡ thá»‘ng nÃ y lÃ  1 mÃ´ hÃ¬nh Generative Pre-trained Transformer 3 (GPT-3) vá»›i sá»‘ lÆ°á»£ng tham sá»‘ khá»•ng lá»“ (175 tá»·), chá»‰ riÃªng viá»‡c lÆ°u mÃ´ hÃ¬nh nÃ y thÃ´i cÅ©ng cáº§n Ä‘áº¿n 800 GB! Ngay cáº£ khi OpenAI cÃ´ng bá»‘ mÃ´ hÃ¬nh nÃ y cho cá»™ng Ä‘á»“ng thÃ¬ cÅ©ng khÃ´ng thá»ƒ tá»± sá»­ dá»¥ng Ä‘Æ°á»£c vá»›i kinh phÃ­ khiÃªm tá»‘n.</p><p>May máº¯n lÃ  cÃ³ má»™t mÃ´ hÃ¬nh GPT khÃ¡c Ä‘áº¿n tá»« cá»™ng Ä‘á»“ng AI Viá»‡t Nam, tÃªn lÃ  <a href="https://huggingface.co/VietAI/gpt-j-6B-vietnamese-news">GPT-J 6B Vietnamese News</a>, Ä‘Æ°á»£c train bá»Ÿi VietAI. MÃ´ hÃ¬nh nÃ y chá»‰ cÃ³ 6 tá»· tham sá»‘, Ä‘á»§ nhá» Ä‘á»ƒ cháº¡y trÃªn nhá»¯ng con GPU giÃ¡ ráº». Trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ hÆ°á»›ng dáº«n cÃ¡ch triá»ƒn khai mÃ´ hÃ¬nh nÃ y lÃªn mÃ´i trÆ°á»ng Docker vÃ  K8S, sá»­ dá»¥ng thÃ´ng qua API Ä‘á»ƒ láº¥y káº¿t quáº£.</p><p>Link tá»›i Github repo chá»©a code trong bÃ i viáº¿t nÃ y: <a href="https://github.com/duydvu/gpt-j-6B-vietnamese-news-api">https://github.com/duydvu/gpt-j-6B-vietnamese-news-api</a></p><p><escape><a id="more"></a></escape></p><h1 id="Load-va-chay-thu-mo-hinh"><a href="#Load-va-chay-thu-mo-hinh" class="headerlink" title="Load vÃ  cháº¡y thá»­ mÃ´ hÃ¬nh"></a>Load vÃ  cháº¡y thá»­ mÃ´ hÃ¬nh</h1><p>TrÆ°á»›c khi cháº¡y thá»­ mÃ´ hÃ¬nh nÃ y, báº¡n cáº§n Ä‘áº£m báº£o Ä‘á»§ bá»™ nhá»› GPU Ä‘á»ƒ load mÃ´ hÃ¬nh lÃªn mÃ¡y. YÃªu cáº§u tá»‘i thiá»ƒu lÃ  khoáº£ng 17 GB. Náº¿u báº¡n cÃ³ nhiá»u hÆ¡n 1 GPU vÃ  tá»•ng bá»™ nhá»› nhiá»u hÆ¡n con sá»‘ nÃ y thÃ¬ váº«n cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c. MÃ¬nh Ä‘Ã£ thá»­ thÃ nh cÃ´ng trÃªn 2 card GTX 1080Ti 12GB.</p><p>BÆ°á»›c Ä‘áº§u tiÃªn lÃ  load tokenizer vÃ  tham sá»‘ cá»§a mÃ´ hÃ¬nh:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModelForCausalLM<br><br><span class="hljs-comment"># Load tokenizer</span><br>tokenizer = AutoTokenizer.from_pretrained(model_path)<br><br><span class="hljs-comment"># Load tham sá»‘ mÃ´ hÃ¬nh</span><br>model = AutoModelForCausalLM.from_pretrained(model_path,<br>                                             torch_dtype=torch.float16,<br>                                             low_cpu_mem_usage=<span class="hljs-literal">True</span>)<br>model.parallelize() <span class="hljs-comment"># Chia nhá» mÃ´ hÃ¬nh vÃ  phÃ¢n bá»• lÃªn nhiá»u GPU Ä‘á»ƒ trÃ¡nh bá»‹ lá»—i OOM</span><br></code></pre></td></tr></table></figure><p>Trong Ä‘oáº¡n code trÃªn, mÃ¬nh thá»±c hiá»‡n 2 phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u:</p><ol><li>Sá»­ dá»¥ng kiá»ƒu dá»¯ liá»‡u float16 thay vÃ¬ float32 Ä‘á»ƒ giáº£m dung lÆ°á»£ng bá»™ nhá»› trÃªn GPU. VÃ¬ float16 tÆ°Æ¡ng á»©ng vá»›i 2 byte cÃ²n float32 tá»›i 4 byte nÃªn tiáº¿t kiá»‡m Ä‘Æ°á»£c 50% dung lÆ°á»£ng.</li><li>VÃ¬ mÃ´ hÃ¬nh nÃ y váº«n ráº¥t lá»›n so vá»›i dung lÆ°á»£ng bá»™ nhá»› cá»§a cÃ¡c loáº¡i GPU phá»• biáº¿n, náº¿u báº¡n cÃ³ nhiá»u GPU thÃ¬ cÃ³ thá»ƒ phÃ¢n bá»• cÃ¡c tham sá»‘ cá»§a mÃ´ hÃ¬nh trÃªn nhiá»u GPU thay vÃ¬ chá»‰ cháº¡y trÃªn 1 con. PhÆ°Æ¡ng phÃ¡p nÃ y cÃ³ tÃªn lÃ  <strong>Model Parallel</strong>.</li></ol><p>Sau khi Ä‘Ã£ xong bÆ°á»›c 1, cháº¡y thá»­ mÃ´ hÃ¬nh Ä‘á»ƒ kiá»ƒm tra xem cÃ³ bá»‹ lá»—i gÃ¬ khÃ´ng:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Convert Ä‘oáº¡n text tá»« dáº¡ng string sang dÃ£y sá»‘ integer </span><br>input_ids = tokenizer.encode(<span class="hljs-string">&quot;Tiá»m nÄƒng cá»§a trÃ­ tuá»‡ nhÃ¢n táº¡o&quot;</span>, return_tensors=<span class="hljs-string">&#x27;pt&#x27;</span>).to(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br><br><span class="hljs-comment"># Cháº¡y mÃ´ hÃ¬nh</span><br>outputs = model.generate(<br>  input_ids,<br>  max_length=<span class="hljs-number">256</span>,<br>  do_sample=<span class="hljs-literal">True</span>,<br>  top_k=<span class="hljs-number">50</span>,<br>  top_p=<span class="hljs-number">0.9</span>,<br>  num_return_sequences=<span class="hljs-number">1</span>,<br>)<br><br><span class="hljs-comment"># Decode káº¿t quáº£ cá»§a mÃ´ hÃ¬nh tá»« dÃ£y sá»‘ integer sang dáº¡ng string vÃ  in ra mÃ n hÃ¬nh</span><br><span class="hljs-keyword">for</span> output <span class="hljs-keyword">in</span> outputs:<br>  <span class="hljs-built_in">print</span>(tokenizer.decode(output, skip_special_tokens=<span class="hljs-literal">True</span>))<br></code></pre></td></tr></table></figure><p>VÃ¬ thuáº­t toÃ¡n sinh vÄƒn báº£n mÃ  mÃ¬nh Ä‘ang sá»­ dá»¥ng lÃ  láº¥y máº«u dá»±a trÃªn xÃ¡c suáº¥t nÃªn sau má»—i láº§n cháº¡y, mÃ´ hÃ¬nh sáº½ cho ra káº¿t quáº£ khÃ¡c nhau. Káº¿t quáº£ thu Ä‘Æ°á»£c trÃªn mÃ¡y cá»§a mÃ¬nh lÃ :</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">Tiá»m nÄƒng cá»§a trÃ­ tuá»‡ nhÃ¢n táº¡o lÃ  ráº¥t lá»›n, nhiá»u á»©ng dá»¥ng cÃ³ thá»ƒ ra Ä‘á»i trong tÆ°Æ¡ng lai khÃ´ng xa, vÃ  Ä‘iá»u Ä‘Ã³ Ä‘Ã²i há»i sá»± ná»— lá»±c cá»§a cáº£ cá»™ng Ä‘á»“ng.<br><br>Má»™t Ä‘iá»ƒm khÃ¡c cáº§n lÆ°u Ã½ lÃ  trÃ­ tuá»‡ nhÃ¢n táº¡o lÃ  má»™t lÄ©nh vá»±c phÃ¡t triá»ƒn hoÃ n toÃ n má»›i vÃ  khÃ´ng thá»ƒ chá»‰ dá»±a vÃ o má»—i viá»‡c nghiÃªn cá»©u cá»§a cÃ¡c trÆ°á»ng, viá»‡n mÃ  pháº£i káº¿t há»£p vá»›i cÃ¡c doanh nghiá»‡p, vÃ  pháº£i cÃ³ sá»± káº¿t ná»‘i máº¡nh máº½ vá»›i cÃ¡c doanh nghiá»‡p.<br><br>Vá» viá»‡c chuáº©n bá»‹ nhÃ¢n lá»±c cho cuá»™c cÃ¡ch máº¡ng cÃ´ng nghiá»‡p láº§n thá»© 4, PhÃ³ Thá»§ tÆ°á»›ng lÆ°u Ã½ cÃ¡c trÆ°á»ng cáº§n cÃ³ sá»± Ä‘á»•i má»›i vá» cÆ¡ cháº¿, phÆ°Æ¡ng phÃ¡p, mÃ´ hÃ¬nh dáº¡y vÃ  há»c nháº±m táº¡o mÃ´i trÆ°á»ng tá»‘t nháº¥t cho trÃ­ tuá»‡ nhÃ¢n táº¡o.<br><br>&quot;Náº¿u cá»© lÃ m theo cÃ¡ch cÅ© thÃ¬ cÃ¡c trÆ°á»ng sáº½ nhÆ° &quot;rÃºc thÃ³c&quot; vÃ o bao, nhÆ°ng náº¿u Ã¡p dá»¥ng phÆ°Æ¡ng phÃ¡p má»›i mÃ  cÃ¡c trÆ°á»ng chÆ°a cÃ³, má»›i á»Ÿ giai Ä‘oáº¡n Ä‘áº§u mÃ  cÃ³ quy mÃ´ lá»›n hÆ¡n nhiá»u láº§n thÃ¬ sáº½ ráº¥t khÃ³ khÄƒn&quot;, PhÃ³ Thá»§ tÆ°á»›ng chia sáº».<br><br>PhÃ³ Thá»§ tÆ°á»›ng VÅ© Äá»©c Äam Ä‘á» nghá»‹ Bá»™ KH&amp;CN tiáº¿p tá»¥c cÃ³ sá»± phá»‘i há»£p vá»›i cÃ¡c bá»™, ngÃ nh, trÆ°á»›c háº¿t lÃ  Bá»™ KH&amp;CN xÃ¢y dá»±ng chiáº¿n lÆ°á»£c, quy hoáº¡ch phÃ¡t triá»ƒn, thá»±c hiá»‡n Ä‘á» Ã¡n tÄƒng cÆ°á»ng.<br></code></pre></td></tr></table></figure><p>Sau khi cháº¡y thá»­ thÃ nh cÃ´ng, mÃ¬nh viáº¿t láº¡i Ä‘oáº¡n code trÃªn thÃ nh 1 class trong file <code>src/predictor.py</code> vÃ  Ä‘Ã³ng gÃ³i toÃ n bá»™ code bao gá»“m cáº£ pháº§n API server vÃ o trong thÆ° má»¥c <code>src</code>.</p><h1 id="Tao-Docker-image"><a href="#Tao-Docker-image" class="headerlink" title="Táº¡o Docker image"></a>Táº¡o Docker image</h1><p>Äá»ƒ build Ä‘Æ°á»£c Docker, trÆ°á»›c háº¿t báº¡n cáº§n pháº£i táº£i mÃ´ hÃ¬nh vá» mÃ¡y theo cÃ¡c bÆ°á»›c sau:</p><ol><li>CÃ i Ä‘áº·t <a href="https://git-lfs.com/">git-lfs</a></li><li>Cháº¡y lá»‡nh <code>git clone https://huggingface.co/VietAI/gpt-j-6B-vietnamese-news</code></li></ol><p>Lá»‡nh clone sáº½ táº£i mÃ´ hÃ¬nh vá» vÃ  Ä‘áº·t á»Ÿ thÆ° má»¥c hiá»‡n táº¡i trÃªn terminal.</p><p>Sau khi táº£i xong, dÃ¹ng lá»‡nh <code>mv</code> Ä‘á»ƒ Ä‘Æ°a thÆ° má»¥c vá»«a clone vá» vÃ o thÆ° má»¥c cá»§a repo API:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> ./gpt-j-6B-vietnamese-news ./gpt-j-6B-vietnamese-news-api<br></code></pre></td></tr></table></figure><p>Cuá»‘i cÃ¹ng lÃ  dÃ¹ng lá»‡nh <code>build</code> Docker image:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -t gpt-j .<br></code></pre></td></tr></table></figure><p>Tiáº¿n hÃ nh cháº¡y thá»­ báº±ng viá»‡c táº¡o 1 container vÃ  map tá»›i port 5000 cá»§a mÃ¡y:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it --<span class="hljs-built_in">rm</span> -p 5000:5000 gpt-j<br></code></pre></td></tr></table></figure><p>Gá»i thá»­ báº±ng lá»‡nh <code>curl</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl --location --request POST <span class="hljs-string">&#x27;http://localhost:5000/predict&#x27;</span> \<br>  --header <span class="hljs-string">&#x27;Content-Type: application/json&#x27;</span> \<br>  --data-raw <span class="hljs-string">&#x27;&#123;</span><br><span class="hljs-string">    &quot;text&quot;: &quot;Tiá»m nÄƒng cá»§a trÃ­ tuá»‡ nhÃ¢n táº¡o&quot;,</span><br><span class="hljs-string">    &quot;n_samples&quot;: 1</span><br><span class="hljs-string">  &#125;&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="Trien-khai-len-moi-truong-K8S-voi-Helm-Chart"><a href="#Trien-khai-len-moi-truong-K8S-voi-Helm-Chart" class="headerlink" title="Triá»ƒn khai lÃªn mÃ´i trÆ°á»ng K8S vá»›i Helm Chart"></a>Triá»ƒn khai lÃªn mÃ´i trÆ°á»ng K8S vá»›i Helm Chart</h1><h2 id="Mot-chut-phan-tich"><a href="#Mot-chut-phan-tich" class="headerlink" title="Má»™t chÃºt phÃ¢n tÃ­ch"></a>Má»™t chÃºt phÃ¢n tÃ­ch</h2><p>Trong bÃ i viáº¿t nÃ y, mÃ¬nh chá»n Google Cloud Platform (GCP) lÃ  nhÃ  cung cáº¥p dá»‹ch vá»¥ cloud Ä‘á»ƒ triá»ƒn khai mÃ´ hÃ¬nh lÃªn K8S vÃ¬ mÃ¬nh thÆ°á»ng xuyÃªn dÃ¹ng GCP trong cÃ´ng viá»‡c. DÃ¹ váº­y, náº¿u báº¡n cÃ³ sá»­ dá»¥ng nhÃ  cung cáº¥p khÃ¡c thÃ¬ cÅ©ng khÃ´ng thÃ nh váº¥n Ä‘á», quan trá»ng lÃ  há» cÃ³ GPU cho K8S lÃ  Ä‘Æ°á»£c.</p><p>Sau khi nghiÃªn cá»©u cÃ¡c má»©c giÃ¡ GPU cá»§a GCP, mÃ¬nh quyáº¿t Ä‘á»‹nh chá»n Nvidia T4 bá»Ÿi 2 tiÃªu chÃ­:</p><ol><li>Má»©c giÃ¡ - giÃ¡ thuÃª hÃ ng thÃ¡ng cá»§a T4 lÃ  gáº§n 180 USD, náº¿u dÃ¹ng spot VM thÃ¬ giÃ¡ chá»‰ cÃ²n 80 USD, cá»™ng vá»›i chi phÃ­ cá»§a CPU, RAM vÃ  disk thÃ¬ khoáº£ng 90 USD, tháº¥p thá»© 2 chá»‰ sau dÃ²ng K80.</li><li>Tá»‘c Ä‘á»™ xá»­ lÃ½ - LÃ½ do mÃ¬nh khÃ´ng chá»n K80 lÃ  vÃ¬ nÃ³ khÃ´ng há»— trá»£ FP16 (<a href="https://docs.nvidia.com/deeplearning/tensorrt/support-matrix/index.html#hardware-precision-matrix">nguá»“n tham kháº£o</a>), giÃºp giáº£m bá»™ nhá»› cÅ©ng nhÆ° tÄƒng tá»‘c Ä‘á»™ cháº¡y mÃ´ hÃ¬nh.</li></ol><p>Vá»›i dung lÆ°á»£ng 16 GB, cáº§n tá»›i 2 card T4 thÃ¬ má»›i cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c mÃ´ hÃ¬nh GPT-J nÃ y. NhÆ° váº­y chi phÃ­ hÃ ng thÃ¡ng náº¿u duy trÃ¬ liÃªn tá»¥c lÃ  90 x 2=180 USD. Náº¿u chá»‰ thá»‰nh thoáº£ng cháº¡y thÃ¬ chi phÃ­ sáº½ cÃ²n tháº¥p hÆ¡n ná»¯a.</p><h2 id="Bat-dau-trien-khai"><a href="#Bat-dau-trien-khai" class="headerlink" title="Báº¯t Ä‘áº§u triá»ƒn khai"></a>Báº¯t Ä‘áº§u triá»ƒn khai</h2><p>Helm lÃ  má»™t cÃ´ng cá»¥ ráº¥t tuyá»‡t vá»i cho viá»‡c Ä‘Ã³ng gÃ³i á»©ng dá»¥ng mÃ  chÃºng ta vá»«a táº¡o Ä‘á»ƒ Ä‘Æ°a lÃªn K8S. MÃ¬nh Ä‘Ã£ táº¡o Helm Chart vÃ  Ä‘á»ƒ trong thÆ° má»¥c <code>k8s/chart</code>. Chart nÃ y bao gá»“m 2 thÃ nh pháº§n:</p><ol><li>Deployment: Táº¡o deployment chá»©a pod cháº¡y container gpt-j.</li><li>Service: Táº¡o service káº¿t ná»‘i tá»›i pod trong deployment á»Ÿ trÃªn.</li></ol><p>Trong pháº§n deployment cÃ³ 2 pháº§n quan trá»ng cáº§n lÆ°u Ã½, má»™t lÃ :</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">strategy:</span><br>  <span class="hljs-attr">rollingUpdate:</span><br>    <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br></code></pre></td></tr></table></figure><p>Máº·c Ä‘á»‹nh trong K8S khi cáº­p nháº­t deployment thÃ¬ sáº½ táº¡o thÃªm 1 pod má»›i cháº¡y song song vá»›i pod cÅ©, nhÆ°ng trong trÆ°á»ng há»£p nÃ y mÃ¬nh chá»‰ cÃ³ Ä‘á»§ GPU Ä‘á»ƒ cháº¡y cho 1 pod nÃªn K8S sáº½ khÃ´ng thá»ƒ thay tháº¿ Ä‘Æ°á»£c pod cÅ© vÃ¬ khÃ´ng cÃ³ GPU Ä‘á»ƒ cháº¡y pod má»›i. VÃ¬ váº­y mÃ¬nh thay Ä‘á»•i strategy Ä‘á»ƒ khi cáº­p nháº­t deployment thÃ¬ K8S sáº½ xÃ³a pod cÅ© trÆ°á»›c khi táº¡o pod má»›i. NhÆ° váº­y thÃ¬ sáº½ khÃ´ng bá»‹ hiá»‡n tÆ°á»£ng trÃªn, nhÆ°ng sáº½ bá»‹ váº¥n Ä‘á» khÃ¡c lÃ  xáº£y ra downtime trong quÃ¡ trÃ¬nh deploy.</p><p>Hai lÃ :</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs YAML"><span class="hljs-attr">resources:</span><br>  <span class="hljs-attr">requests:</span><br>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">8000Mi</span><br>    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-string">&quot;2&quot;</span><br>  <span class="hljs-attr">limits:</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">16000Mi</span><br>    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-string">&quot;2&quot;</span><br></code></pre></td></tr></table></figure><p>CÃ³ 2 dÃ²ng quan trá»ng lÃ  <code>nvidia.com/gpu: &quot;2&quot;</code> dÃ¹ng Ä‘á»ƒ cáº¥p phÃ¡t tÃ i nguyÃªn GPU cho pod. Báº¯t buá»™c pháº£i cÃ³ 2 dÃ²ng nÃ y thÃ¬ pod má»›i cÃ³ thá»ƒ dÃ¹ng GPU Ä‘Æ°á»£c. Má»™t Ä‘iá»ƒm trá»« lÃ  hiá»‡n táº¡i GCP chá»‰ cho phÃ©p 1 GPU Ä‘Æ°á»£c cáº¥p phÃ¡t tá»›i 1 pod nÃªn nhiá»u pod khÃ´ng thá»ƒ chia sáº½ cÃ¹ng 1 GPU Ä‘Æ°á»£c. Náº¿u cÃ³ nhiá»u mÃ´ hÃ¬nh khÃ¡c cáº§n dÃ¹ng tá»›i GPU thÃ¬ tá»‘t nháº¥t báº¡n nÃªn dÃ¹ng cÃ¡c giáº£i phÃ¡p cháº¡y mÃ´ hÃ¬nh táº­p trung nhÆ° <a href="https://github.com/triton-inference-server/server">Triton</a> Ä‘á»ƒ cÃ³ thá»ƒ cháº¡y nhiá»u mÃ´ hÃ¬nh trÃªn cÃ¹ng 1 GPU.</p><p>BÆ°á»›c cuá»‘i cÃ¹ng lÃ  cÃ i Ä‘áº·t Helm Chart nÃ y lÃªn K8S thÃ´ng qua lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm install --<span class="hljs-built_in">set</span> namespace=default --<span class="hljs-built_in">set</span> image=gpt-j --<span class="hljs-built_in">set</span> version=latest gpt-j ./k8s/chart<br></code></pre></td></tr></table></figure><p>NhÆ° váº­y lÃ  chÃºng ta Ä‘Ã£ thÃ nh cÃ´ng trong viá»‡c triá»ƒn khai GPT-J lÃªn K8S rá»“i Ä‘Ã³. ChÃºc báº¡n cÅ©ng thÃ nh cÃ´ng nhÆ° mÃ¬nh nhÃ©!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Machine Learning</tag>
      
      <tag>Deep Learning</tag>
      
      <tag>Docker</tag>
      
      <tag>Artificial Intelligence</tag>
      
      <tag>GPT-J</tag>
      
      <tag>K8S</tag>
      
      <tag>Natural Language Generation</tag>
      
      <tag>Language Model</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cáº¥u hÃ¬nh GPU trong Docker</title>
    <link href="/2021/01/10/Cau-hinh-GPU-trong-Docker/"/>
    <url>/2021/01/10/Cau-hinh-GPU-trong-Docker/</url>
    
    <content type="html"><![CDATA[<p>Trong bÃ i <a href="/2021/01/05/Cach-thiet-lap-moi-truong-Docker-cho-server-Jupyter-cua-ban">trÆ°á»›c</a>, mÃ¬nh Ä‘Ã£ trÃ¬nh bÃ y cÃ¡ch thiáº¿t láº­p mÃ´i trÆ°á»ng Docker Ä‘á»ƒ cháº¡y server Jupyter. Vá»›i nÃ³, báº¡n cÃ³ thá»ƒ cÃ i Ä‘áº·t báº¥t ká»³ package nÃ o mÃ  báº¡n muá»‘n nhÆ° scikit-learn, Tensorflow, PyTorch. NhÆ°ng nhá»¯ng thÆ° viá»‡n nÃ y sáº½ khÃ´ng thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c GPU trong mÃ¡y báº¡n nhÆ° khi cÃ i trá»±c tiáº¿p trÃªn há»‡ Ä‘iá»u hÃ nh bá»Ÿi vÃ¬ báº¡n chÆ°a cáº¥u hÃ¬nh GPU cho container cá»§a báº¡n. Trong bÃ i nÃ y, mÃ¬nh sáº½ hÆ°á»›ng dáº«n báº¡n cÃ¡ch Ä‘á»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c GPU trong Docker.</p><p>MÃ¬nh giáº£ Ä‘á»‹nh ráº±ng mÃ¡y cá»§a báº¡n Ä‘ang dÃ¹ng Nvidia GPU vÃ  báº¡n Ä‘Ã£ cÃ i driver cáº§n thiáº¿t trÃªn há»‡ Ä‘iá»u hÃ nh Ubuntu rá»“i. Náº¿u báº¡n chÆ°a cÃ i Ä‘áº·t driver cho GPU thÃ¬ vÃ o Ä‘Æ°á»ng link á»Ÿ <a href="https://www.nvidia.com/Download/index.aspx">Ä‘Ã¢y</a>, chá»n táº£i rá»“i cÃ i driver trÆ°á»›c nhÃ©.</p><p><escape><a id="more"></a></escape></p><h2 id="Cai-dat-nvidia-container-runtime"><a href="#Cai-dat-nvidia-container-runtime" class="headerlink" title="CÃ i Ä‘áº·t nvidia-container-runtime"></a>CÃ i Ä‘áº·t nvidia-container-runtime</h2><p>Má»Ÿ terminal vÃ  cháº¡y Ä‘oáº¡n lá»‡nh dÆ°á»›i Ä‘Ã¢y:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -s -L https://nvidia.github.io/nvidia-container-runtime/gpgkey | \<br>  sudo apt-key add -<br>distribution=$(. /etc/os-release;<span class="hljs-built_in">echo</span> $ID<span class="hljs-variable">$VERSION_ID</span>)<br>curl -s -L https://nvidia.github.io/nvidia-container-runtime/<span class="hljs-variable">$distribution</span>/nvidia-container-runtime.list | \<br>  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-runtime.list<br>sudo apt-get update<br></code></pre></td></tr></table></figure><p>Sau Ä‘Ã³, nháº­p lá»‡nh sau Ä‘á»ƒ cÃ i Ä‘áº·t nvidia-container-runtime:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install nvidia-container-runtime<br></code></pre></td></tr></table></figure><p>Khá»Ÿi Ä‘á»™ng láº¡i Docker server:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo service docker restart<br></code></pre></td></tr></table></figure><p>Tháº¿ lÃ  xong. Äáº¿n bÆ°á»›c tiáº¿p theo lÃ  khá»Ÿi Ä‘á»™ng 1 container má»›i vá»›i cáº¥u hÃ¬nh cho phÃ©p truy cáº­p GPU.</p><h2 id="Khoi-dong-Docker-container"><a href="#Khoi-dong-Docker-container" class="headerlink" title="Khá»Ÿi Ä‘á»™ng Docker container"></a>Khá»Ÿi Ä‘á»™ng Docker container</h2><p>Äá»ƒ sá»­ dá»¥ng GPU trong 1 container, báº¡n pháº£i thÃªm tham sá»‘ <code>--gpus</code> trong lá»‡nh cháº¡y <code>docker run</code>. VÃ­ dá»¥:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -p 8888:8888 --gpus all jupyter-server<br></code></pre></td></tr></table></figure><p>Tham sá»‘ <code>--gpus</code> cÃ³ giÃ¡ trá»‹ lÃ  <code>all</code> á»Ÿ Ä‘Ã¢y nghÄ©a lÃ  báº¡n cho phÃ©p container nÃ y truy cáº­p vÃ o toÃ n bá»™ GPU mÃ  mÃ¡y báº¡n Ä‘ang cÃ³. Hoáº·c lÃ  báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh nhá»¯ng GPU cá»¥ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng trong container.</p><p>Má»—i GPU trong mÃ¡y Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ trá»‹ index báº¯t Ä‘áº§u tá»« 0. VÃ­ dá»¥ náº¿u báº¡n cÃ³ 2 GPU thÃ¬ chÃºng sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh index láº§n lÆ°á»£t lÃ  0 vÃ  1. Äá»ƒ xem index cá»§a tá»«ng GPU vÃ  cÃ¡c thÃ´ng sá»‘ khÃ¡c nhÆ° memory, usage thÃ¬ cÃ³ thá»ƒ dÃ¹ng lá»‡nh <code>nvidia-smi</code>. VÃ­ dá»¥ nhÆ° trong hÃ¬nh dÆ°á»›i Ä‘Ã¢y:</p><p><img src="/2021/01/10/Cau-hinh-GPU-trong-Docker/Screenshot-2021-01-10-121331.png" alt="VÃ­ dá»¥ cháº¡y lá»‡nh nvidia-smi"></p><p>á» cá»™t ngoÃ i cÃ¹ng bÃªn trÃ¡i, báº¡n sáº½ tháº¥y index cá»§a tá»«ng GPU. á» Ä‘Ã¢y cÃ³ 2 GPU nÃªn Ä‘Æ°á»£c Ä‘Ã¡nh láº§n lÆ°á»£t 0 vÃ  1. GPU 0 Ä‘ang sá»­ dá»¥ng 4905 MB / 11178 MB, cÃ²n GPU 1 thÃ¬ Ä‘ang dÃ¹ng 11140 MB / 11178 MB. Náº¿u báº¡n chá»‰ muá»‘n cáº¥p cho container sá»­ dá»¥ng GPU 0 thÃ¬ dÃ¹ng lá»‡nh nhÆ° sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -p 8888:8888 --gpus device=0 jupyter-server<br></code></pre></td></tr></table></figure><p>Hoáº·c náº¿u báº¡n cÃ³ nhiá»u hÆ¡n 2 GPU thÃ¬ báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh báº¥t ká»³ GPU nÃ o Ä‘Æ°á»£c dÃ¹ng trong container nhÆ° sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -p 8888:8888 --gpus device=0,2,4 jupyter-server<br></code></pre></td></tr></table></figure><h2 id="Tong-ket"><a href="#Tong-ket" class="headerlink" title="Tá»•ng káº¿t"></a>Tá»•ng káº¿t</h2><p>Giá» Ä‘Ã¢y báº¡n cÃ³ thá»ƒ cÃ i thÆ° viá»‡n Tensorflow GPU hay PyTorch trong server Jupyter lÃ  cÃ³ thá»ƒ dÃ¹ng Ä‘Æ°á»£c ngay GPU. Vá»›i Docker, báº¡n cÃ³ thá»ƒ tha há»“ cÃ i Ä‘áº·t báº¥t ká»³ pháº§n má»m nÃ o mÃ  báº¡n muá»‘n.</p><p>MÃ¬nh cÅ©ng chia sáº» thÃªm má»™t sá»‘ package ráº¥t há»¯u Ã­ch mÃ  mÃ¬nh hay dÃ¹ng trong cÃ´ng viá»‡c:</p><ul><li><strong>tmux</strong>: cho phÃ©p báº¡n quáº£n lÃ½ terminal theo phong cÃ¡ch xá»‹n xÃ² nhÆ° 1 hacker, báº¡n cÃ³ thá»ƒ cháº¡y 1 chÆ°Æ¡ng trÃ¬nh trong terminal vÃ  táº¯t nÃ³ Ä‘i mÃ  khÃ´ng sá»£ bá»‹ dá»«ng chÆ°Æ¡ng trÃ¬nh.</li><li><a href="https://github.com/ohmyzsh/ohmyzsh"><strong>ohmyzsh</strong></a>: terminal Ä‘áº¹p lung linh kÃ¨m theo 1 sá»‘ plugin nhÆ° git cho phÃ©p báº¡n thao tÃ¡c trÃªn terminal tiá»‡n lá»£i vÃ  thÃ­ch thÃº hÆ¡n.</li></ul><p>Happy Coding!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Docker</tag>
      
      <tag>Jupyter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CÃ¡ch thiáº¿t láº­p mÃ´i trÆ°á»ng Docker cho server Jupyter cá»§a báº¡n</title>
    <link href="/2021/01/05/Cach-thiet-lap-moi-truong-Docker-cho-server-Jupyter-cua-ban/"/>
    <url>/2021/01/05/Cach-thiet-lap-moi-truong-Docker-cho-server-Jupyter-cua-ban/</url>
    
    <content type="html"><![CDATA[<p>Jupyter Notebook vÃ  Jupyter Lab lÃ  2 mÃ´i trÆ°á»ng tuyá»‡t vá»i cho data scientist thá»±c hÃ nh vá»›i dá»¯ liá»‡u cá»§a mÃ¬nh. Tuy nhiÃªn, Ä‘Ã´i khi viá»‡c thá»±c hÃ nh vá»›i dá»¯ liá»‡u gáº·p 1 chÃºt khÃ³ khÄƒn. NÃ o lÃ  cÃ i Ä‘áº·t Java Ä‘á»ƒ cháº¡y VnCoreNLP, cÃ i tensorflow GPU Ä‘á»ƒ huáº¥n luyá»‡n model, cÃ i cmake Ä‘á»ƒ cÃ i CocCoc Tokenizer, quáº£n lÃ½ dependency,â€¦ CÃ³ khi báº¡n lá»¡ lÃ m sai gÃ¬ Ä‘Ã³ khiáº¿n cho mÃ¡y báº¡n gáº·p váº¥n Ä‘á» mÃ  khÃ´ng biáº¿t giáº£i quyáº¿t lÃ m sao, vá»«a tá»‘n cÃ´ng sá»©c vá»«a tá»‘n thá»i gian cho nhá»¯ng tÃ¡c vá»¥ khÃ´ng liÃªn quan. Docker chÃ­nh lÃ  chÃ¬a khÃ³a Ä‘á»ƒ giÃ¡i quyáº¿t nhá»¯ng váº¥n Ä‘á» trÃªn. BÃ i viáº¿t nÃ y sáº½ hÆ°á»›ng dáº«n báº¡n cÃ¡ch thiáº¿t láº­p mÃ´i trÆ°á»ng Docker Ä‘á»ƒ cháº¡y server Jupyter cá»§a báº¡n.</p><p><escape><a id="more"></a></escape></p><h2 id="Docker-la-gi"><a href="#Docker-la-gi" class="headerlink" title="Docker lÃ  gÃ¬?"></a>Docker lÃ  gÃ¬?</h2><p>Náº¿u báº¡n chÆ°a biáº¿t vá» Docker hoáº·c biáº¿t 1 chÃºt vÃ  muá»‘n tÃ¬m hiá»ƒu thÃªm thÃ¬ nÃªn Ä‘á»c pháº§n nÃ y, náº¿u khÃ´ng thÃ¬ báº¡n cÃ³ thá»ƒ kÃ©o xuá»‘ng <a href="#Tao-Docker-image">pháº§n tiáº¿p theo</a>.</p><p>Docker lÃ  1 mÃ´i trÆ°á»ng áº£o hÃ³a giá»‘ng nhÆ° VirtualBox hay VMware. Náº¿u báº¡n Ä‘Ã£ tá»«ng dÃ¹ng mÃ¡y áº£o Ä‘á»ƒ cháº¡y 1 há»‡ Ä‘iá»u hÃ nh thÃ¬ cÃ³ thá»ƒ tháº¥y ráº±ng chÃºng cung cáº¥p cho báº¡n 1 mÃ´i trÆ°á»ng Ä‘á»™c láº­p vá»›i mÃ¡y chÃ­nh, nhá»¯ng gÃ¬ báº¡n lÃ m trÃªn mÃ¡y áº£o khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n mÃ¡y chÃ­nh. Náº¿u báº¡n lá»¡ phÃ¡ gÃ¬ Ä‘Ã³ hay dÃ­nh malware thÃ¬ chá»‰ cáº§n reset mÃ¡y áº£o Ä‘Ã³ Ä‘i lÃ  xong. Sá»± tiá»‡n lá»£i nÃ y khiáº¿n cho mÃ¡y áº£o ráº¥t thÃ­ch há»£p cho viá»‡c phÃ¡t triá»ƒn pháº§n má»m, triá»ƒn khai pháº§n má»m, test virus,â€¦ NhÆ°ng cÅ©ng chÃ­nh sá»± tiá»‡n lá»£i nÃ y khiáº¿n cho nÃ³ tá»‘n ráº¥t nhiá»u tÃ i nguyÃªn cá»§a mÃ¡y. VÃ¬ váº­y, viá»‡c sá»­ dá»¥ng mÃ¡y áº£o tÆ°Æ¡ng Ä‘á»‘i khÃ³ khÄƒn.</p><p>Docker ra Ä‘á»i nháº±m kháº¯c phá»¥c nhá»¯ng háº¡n cháº¿ trÃªn cá»§a mÃ¡y áº£o. Äá»‘i vá»›i mÃ¡y áº£o, nÃ³ dÃ¹ng 1 thÃ nh pháº§n gá»i lÃ  hypervisor Ä‘á»ƒ mÃ´ phá»ng pháº§n cá»©ng cá»§a nhiá»u mÃ¡y trÃªn 1 mÃ¡y, nhá» Ä‘Ã³ cho phÃ©p nhiá»u mÃ¡y áº£o cháº¡y trÃªn 1 mÃ¡y chÃ­nh duy nháº¥t, má»—i mÃ¡y áº£o cÃ³ thá»ƒ cháº¡y há»‡ Ä‘iá»u hÃ nh khÃ¡c nhau. Trong khi Ä‘Ã³, Docker táº­n dá»¥ng há»‡ Ä‘iá»u hÃ nh cá»§a mÃ¡y chÃ­nh Ä‘á»ƒ cháº¡y cÃ¡c container trÃªn Ä‘Ã³, má»—i container lÃ  1 pháº§n má»m Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i cháº¡y hoÃ n toÃ n Ä‘á»™c láº­p vá»›i nhau. Báº¡n cÃ³ thá»ƒ lÃ m gáº§n nhÆ° báº¥t cá»© Ä‘iá»u gÃ¬ trÃªn container nÃ y mÃ  khÃ´ng áº£nh hÆ°á»›ng Ä‘áº¿n container khÃ¡c. HÃ¬nh dÆ°á»›i Ä‘Ã¢y sáº½ giáº£i thÃ­ch rÃµ hÆ¡n vá» sá»± khÃ¡c nhau giá»¯a 2 kiáº¿n trÃºc nÃ y.</p><p><img src="/2021/01/05/Cach-thiet-lap-moi-truong-Docker-cho-server-Jupyter-cua-ban/docker.png" alt="So sÃ¡nh kiáº¿n trÃºc giá»¯a Docker vÃ  mÃ¡y áº£o"></p><p>Nhá» vÃ o viá»‡c táº­n dá»¥ng tÃ i nguyÃªn cÃ³ sáºµn trong há»‡ Ä‘iá»u hÃ nh cá»§a mÃ¡y chÃ­nh, Docker tiÃªu tá»‘n Ã­t RAM vÃ  dung lÆ°á»£ng Ä‘Ä©a hÆ¡n so vá»›i mÃ¡y áº£o. Qua Ä‘Ã³ táº¡o Ä‘iá»u kiá»‡n thuáº­n lá»£i cho cÃ¡c nhÃ  phÃ¡t triá»ƒn sá»­ dá»¥ng Docker Ä‘á»ƒ viá»‡c phÃ¡t triá»ƒn pháº§n má»m trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n, tÃ¬nh tráº¡ng code cháº¡y á»•n trÃªn mÃ¡y nÃ y nhÆ°ng bá»‹ bug trÃªn mÃ¡y kia Ä‘Æ°á»£c giáº£m thiá»ƒu vÃ¬ giá» Ä‘Ã¢y code Ä‘á»u cháº¡y trÃªn cÃ¹ng 1 mÃ´i trÆ°á»ng. Triá»ƒn khai pháº§n má»m cÅ©ng dá»… dÃ ng hÆ¡n, trÆ°á»›c Ä‘Ã¢y thÃ¬ DevOps pháº£i biáº¿t vá» cÃ¡c dependency cá»§a pháº§n má»m Ä‘á»ƒ cÃ i Ä‘áº·t trÆ°á»›c khi triá»ƒn khai, giá» thÃ¬ chá»‰ cáº§n Developer táº¡o 1 image chá»©a pháº§n má»m vÃ  táº¥t cáº£ dependency rá»“i Ä‘Æ°a nÃ³ cho DevOps, tá»›i lÆ°á»£t DevOps thÃ¬ chá»‰ cáº§n <code>run</code> nÃ³ lÃ  xong.</p><p>Äá»‘i vá»›i Data Scientist, viá»‡c sá»­ dá»¥ng Docker cÅ©ng giÃºp Ã­ch ráº¥t nhiá»u. VÃ­ dá»¥ báº¡n cÃ³ 1 tool yÃªu cáº§u Python 3.7 Ä‘á»ƒ cháº¡y nhÆ°ng báº¡n láº¡i Ä‘ang dÃ¹ng Python 3.5 thÃ¬ báº¡n khÃ´ng cáº§n pháº£i nÃ¢ng cáº¥p Python cá»§a mÃ¡y mÃ  chá»‰ cáº§n cháº¡y tool Ä‘Ã³ trong 1 container cÃ³ Python 3.7 lÃ  xong. Hoáº·c lÃ  trong quÃ¡ trÃ¬nh cÃ i Ä‘áº·t cÃ¡c pháº§n má»m trÃªn mÃ¡y, Ä‘Ã´i lÃºc báº¡n sáº½ gáº·p trÆ°á»ng há»£p lá»—i do cáº¥u hÃ¬nh sai gÃ¬ Ä‘Ã³, náº¿u mÃ  báº¡n khÃ´ng tÃ¬m Ä‘Æ°á»£c cÃ¡ch sá»­a thÃ¬ sáº½ tiÃªu tá»‘n khÃ¡ nhiá»u thá»i gian. NgÆ°á»£c láº¡i, khi báº¡n cÃ i trÃªn Docker thÃ¬ chá»‰ cáº§n xÃ³a container Ä‘ang cháº¡y rá»“i khá»Ÿi Ä‘á»™ng láº¡i cÃ¡i khÃ¡c lÃ  xong. Má»i thá»© ráº¥t nhanh pháº£i khÃ´ng nÃ o!</p><p>Docker cÃ²n mang láº¡i nhiá»u lá»£i Ã­ch hÆ¡n trong 1 team R&amp;D cÃ³ nhiá»u Data Scientist. Báº¡n khÃ´ng cáº§n pháº£i quan tÃ¢m Ä‘áº¿n viá»‡c cÃ i Ä‘áº·t hay cáº­p nháº­t package nÃ y cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n thÃ nh viÃªn khÃ¡c trong team hay khÃ´ng, vÃ¬ má»i thá»© Ä‘Ã£ Ä‘Æ°á»£c <strong>isolated</strong> trong 1 container. CÃ³ thá»ƒ báº¡n sáº½ nghÄ© ráº±ng virtualenv cá»§a Python cho phÃ©p lÃ m Ä‘iá»u tÆ°Æ¡ng tá»±, nhÆ°ng Docker cho phÃ©p lÃ m nhiá»u hÆ¡n tháº¿ khÃ´ng chá»‰ cÃ³ má»—i quáº£n lÃ½ Python package. Giáº£ sá»­ nhÆ° báº¡n muá»‘n dÃ¹ng Java phiÃªn báº£n má»›i hÆ¡n Ä‘á»ƒ cháº¡y tool nÃ y nhÆ°ng Ä‘á»“ng nghiá»‡p cá»§a báº¡n láº¡i Ä‘ang dÃ¹ng phiÃªn báº£n cÅ© hÆ¡n khÃ´ng tÆ°Æ¡ng thÃ­ch thÃ¬ sao?</p><p>TÃ³m láº¡i, Docker lÃ  1 cÃ´ng cá»¥ tuyá»‡t vá»i Ä‘Ã£, Ä‘ang vÃ  sáº½ ngÃ y cÃ ng phÃ¡t triá»ƒn trong tÆ°Æ¡ng lai, Ä‘Ã³ng má»™t vai trÃ² quan trá»ng trong viá»‡c phÃ¡t triá»ƒn pháº§n má»m cá»§a tháº¿ giá»›i. VÃ¬ váº­y, náº¿u báº¡n chÆ°a rÃ nh vá» Docker thÃ¬ mÃ¬nh khuyÃªn báº¡n nÃªn báº¯t Ä‘áº§u tÃ¬m hiá»ƒu nÃ³ Ä‘á»ƒ cáº£m nháº­n rÃµ Ä‘Æ°á»£c nhá»¯ng lá»£i Ã­ch cá»§a nÃ³ nhÃ©.</p><p>Nguá»“n tÃ i liá»‡u Ä‘á»ƒ há»c Docker:</p><ul><li><a href="https://docs.docker.com/get-started/overview/">Docker Documentation</a></li><li><a href="https://www.youtube.com/watch?v=1k8pox8mkxc">Video hÆ°á»›ng dáº«n vá» Docker ráº¥t bá»• Ã­ch cá»§a anh Pháº¡m Huy HoÃ ng</a></li></ul><p>TrÆ°á»›c khi Ä‘i vÃ o pháº§n káº¿ tiáº¿p, báº¡n hÃ£y cháº¯c ráº±ng mÃ¬nh Ä‘Ã£ náº¯m Ä‘Æ°á»£c nhá»¯ng kiáº¿n thá»©c cÆ¡ báº£n cá»§a Docker nhÆ° image, container lÃ  gÃ¬ rá»“i hÃ£y báº¯t Ä‘áº§u nhÃ©.</p><h2 id="Tao-Docker-image"><a href="#Tao-Docker-image" class="headerlink" title="Táº¡o Docker image"></a>Táº¡o Docker image</h2><p>OK. Trong pháº§n nÃ y mÃ¬nh sáº½ hÆ°á»›ng dáº«n cÃ¡ch táº¡o 1 image dÃ¹ng Ä‘á»ƒ cháº¡y server Jupyter.</p><p>Trong thÆ° má»¥c trá»‘ng báº¥t ká»³, táº¡o 1 file má»›i vÃ  Ä‘áº·t tÃªn lÃ  <code>Dockerfile</code>, lÆ°u Ã½ lÃ  khÃ´ng Ä‘Æ°á»£c cÃ³ Ä‘uÃ´i extension. Má»Ÿ file nÃ y báº±ng 1 trÃ¬nh editor vÃ  copy ná»™i dung sau vÃ o file:</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs docker"><span class="hljs-comment"># CÃ³ thá»ƒ chá»n image khÃ¡c á»Ÿ https://hub.docker.com/_/python</span><br><span class="hljs-keyword">FROM</span> python:<span class="hljs-number">3.7</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip install jupyterlab</span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /code</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;jupyter-lab&quot;</span>, <span class="hljs-string">&quot;--ip&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-string">&quot;--allow-root&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>Sau Ä‘Ã³, cháº¡y lá»‡nh trong terminal:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -t jupyter-server .<br></code></pre></td></tr></table></figure><p>Lá»‡nh nÃ y sáº½ build 1 image chá»©a Python 3.7 vÃ  Jupyter trong Ä‘Ã³.</p><p>Sau khi build xong image, bÃ¢y giá» báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ cháº¡y server Jupyter rá»“i. Äá»ƒ cháº¡y server, chá»‰ cáº§n cháº¡y lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -p 8888:8888 jupyter-server<br></code></pre></td></tr></table></figure><p>Báº¡n sáº½ tháº¥y thÃ´ng bÃ¡o server Jupyter Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng kÃ¨m theo token. Má»Ÿ browser truy cáº­p vÃ o Ä‘á»‹a chá»‰ <a href="http://localhost:8888/">http://localhost:8888</a> rá»“i nháº­p token Ä‘Ã³ vÃ o, tháº¿ lÃ  báº¡n Ä‘Ã£ cháº¡y Ä‘Æ°á»£c server Jupyter trÃªn Docker rá»“i.</p><p><strong>LÆ°u Ã½</strong>: Táº¥t cáº£ cÃ¡c file báº¡n táº¡o trÃªn server Jupyter nÃ y Ä‘á»u Ä‘Æ°á»£c náº±m trong container, báº¡n sáº½ khÃ´ng tÃ¬m tháº¥y thÆ° má»¥c code cá»§a báº¡n trong há»‡ thá»‘ng file cá»§a mÃ¡y chÃ­nh. <strong>Náº¿u báº¡n cÃ³ lá»¡ xÃ³a container nÃ y thÃ¬ má»i ná»™i dung báº¡n táº¡o trong nÃ³ cÅ©ng bá»‹ xÃ³a theo</strong>. Äá»ƒ trÃ¡nh Ä‘iá»u nÃ y, báº¡n nÃªn mount thÆ° má»¥c <code>/code</code> trong container lÃªn 1 thÆ° má»¥c trong há»‡ thá»‘ng file cá»§a mÃ¡y chÃ­nh. Äá»ƒ lÃ m Ä‘iá»u váº­y, báº¡n chá»‰ cáº§n thÃªm 1 tham sá»‘ trÆ°á»›c khi cháº¡y container:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -p 8888:8888 -v &lt;path-to-your-directory&gt;:/code jupyter-server<br></code></pre></td></tr></table></figure><p>Thay tháº¿ <code>&lt;path-to-your-directory&gt;</code> thÃ nh Ä‘Æ°á»ng dáº§n Ä‘áº¿n thÆ° má»¥c mÃ  báº¡n muá»‘n Ä‘á»ƒ code á»Ÿ Ä‘Ã³. Tham sá»‘ vá»«a thÃªm vÃ o cÃ³ tÃ¡c dá»¥ng mount thÆ° má»¥c trÃªn mÃ¡y chÃ­nh cá»§a báº¡n lÃªn thÆ° má»¥c <code>/code</code> trong container. Hiá»ƒu Ä‘Æ¡n giáº£n lÃ  tá»« bÃ¢y giá» 2 thÆ° má»¥c nÃ y cÃ³ thá»ƒ Ä‘á»“ng bá»™ vá»›i nhau, náº¿u báº¡n táº¡o 1 file trong thÆ° má»¥c nÃ y thÃ¬ nÃ³ sáº½ xuáº¥t hiá»‡n trong thÆ° má»¥c cÃ²n láº¡i. Náº¿u container bá»‹ xÃ³a thÃ¬ ná»™i dung trong thÆ° má»¥c báº¡n chá»n Ä‘á»ƒ mount vÃ o váº«n y nhÆ° cÅ©.</p><h2 id="Cai-dat-thu-vien"><a href="#Cai-dat-thu-vien" class="headerlink" title="CÃ i Ä‘áº·t thÆ° viá»‡n"></a>CÃ i Ä‘áº·t thÆ° viá»‡n</h2><p>Báº¡n cÃ³ thá»ƒ cÃ i thÃªm cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t vÃ o trong container Ä‘ang cháº¡y báº±ng 1 trong 3 cÃ¡ch sau Ä‘Ã¢y</p><h3 id="Cach-1-Lenh-docker-exec"><a href="#Cach-1-Lenh-docker-exec" class="headerlink" title="CÃ¡ch 1: Lá»‡nh docker exec"></a>CÃ¡ch 1: Lá»‡nh docker exec</h3><p>Äá»ƒ dÃ¹ng lá»‡nh nÃ y, trÆ°á»›c tiÃªn báº¡n cáº§n pháº£i biáº¿t tÃªn hoáº·c ID cá»§a container. Má»Ÿ 1 terminal má»›i vÃ  nháº­p lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker ps<br></code></pre></td></tr></table></figure><p>Lá»‡nh nÃ y sáº½ in ra danh sÃ¡ch nhá»¯ng container Ä‘ang cháº¡y trong Docker server, ná»™i dung tÆ°Æ¡ng tá»± nhÆ° sau:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES<br>b3e70a2ab109        jupyter-server      &quot;jupyter-lab --ip 0.â€¦&quot;   8 minutes ago       Up 7 minutes        0.0.0.0:8888-&gt;8888/tcp   nifty_liskov<br></code></pre></td></tr></table></figure><p>Cá»™t <code>CONTAINER ID</code> hiá»‡n ID cá»§a container cá»§a báº¡n, cÃ²n cá»™t <code>NAMES</code> hiá»‡n tÃªn cá»§a container. Má»—i container khi Ä‘Æ°á»£c táº¡o sáº½ Ä‘Æ°á»£c cáº¥p cho 1 ID vÃ  tÃªn duy nháº¥t trong sá»‘ cÃ¡c container Ä‘ang cÃ²n tá»“n táº¡i trong Docker server. Copy 1 trong 2 field nÃ y tá»« mÃ n hÃ¬nh terminal cá»§a báº¡n vÃ  nháº­p lá»‡nh dÆ°á»›i Ä‘Ã¢y:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it &lt;paste-here&gt; bash<br></code></pre></td></tr></table></figure><p>Sau khi nháº¥n Enter, terminal cá»§a báº¡n sáº½ trá»Ÿ thÃ nh terminal trong container. Giá» báº¡n cÃ³ thá»ƒ cÃ i báº¥t cá»© thÆ° viá»‡n nÃ o trong Ä‘Ã¢y. VÃ­ dá»¥ nhÆ°:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install numpy pandas<br></code></pre></td></tr></table></figure><h3 id="Cach-2-Dung-tinh-nang-shell-command-tren-Jupyter"><a href="#Cach-2-Dung-tinh-nang-shell-command-tren-Jupyter" class="headerlink" title="CÃ¡ch 2: DÃ¹ng tÃ­nh nÄƒng shell command trÃªn Jupyter"></a>CÃ¡ch 2: DÃ¹ng tÃ­nh nÄƒng shell command trÃªn Jupyter</h3><p>Jupyter cho phÃ©p ta cháº¡y báº¥t cá»© lá»‡nh nÃ o trong notebook.</p><p>Äá»ƒ lÃ m váº­y, báº¡n cáº§n pháº£i thÃªm dáº¥u cháº¥m thang (!) vÃ o trÆ°á»›c lá»‡nh shell rá»“i cháº¡y notebook. VÃ­ dá»¥:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">!pip install numpy<br></code></pre></td></tr></table></figure><p>HÃ¬nh dÆ°á»›i Ä‘Ã¢y lÃ  káº¿t quáº£ sau khi cháº¡y lá»‡nh trÃªn trong notebook</p><p><img src="/2021/01/05/Cach-thiet-lap-moi-truong-Docker-cho-server-Jupyter-cua-ban/screenshot.png" alt="Cháº¡y lá»‡nh shell command trong notebook"></p><p>CÃ¡ch nÃ y nhanh hÆ¡n ráº¥t nhiá»u so vá»›i cÃ¡ch 1.</p><h3 id="Cach-3-Dung-terminal-cua-Jupyter-Lab"><a href="#Cach-3-Dung-terminal-cua-Jupyter-Lab" class="headerlink" title="CÃ¡ch 3: DÃ¹ng terminal cá»§a Jupyter Lab"></a>CÃ¡ch 3: DÃ¹ng terminal cá»§a Jupyter Lab</h3><p>TrÃªn thanh cÃ´ng cá»¥ cá»§a Jupyter Lab, chá»n <strong>File</strong> â†’ <strong>New</strong> â†’ <strong>Terminal</strong>. Má»™t tab má»›i Ä‘Æ°á»£c má»Ÿ ra vÃ  báº¡n cÃ³ thá»ƒ nháº­p lá»‡nh vÃ o terminal Ä‘á»ƒ cÃ i thÆ° viá»‡n.</p><p>CÃ¡ch lÃ m nÃ y cháº­m hÆ¡n cÃ¡ch thá»© 2 nhÆ°ng mÃ  phÃ¹ há»£p vá»›i nhá»¯ng tÃ¡c vá»¥ nhÆ° monitor báº±ng lá»‡nh <code>top</code> hoáº·c <code>watch</code> hoáº·c <code>tail</code>.</p><h2 id="Tong-ket"><a href="#Tong-ket" class="headerlink" title="Tá»•ng káº¿t"></a>Tá»•ng káº¿t</h2><p>NhÆ° váº­y lÃ  báº¡n Ä‘Ã£ cÃ³ 1 Docker container cháº¡y server Jupyter Ä‘á»ƒ phá»¥c vá»¥ cho cÃ´ng viá»‡c Data Science. Trong container nÃ y, báº¡n cÃ³ thá»ƒ cÃ i Ä‘áº·t báº¥t cá»© pháº§n má»m nÃ o mÃ  khÃ´ng sá»£ áº£nh hÆ°á»Ÿng Ä‘áº¿n há»‡ Ä‘iá»u hÃ nh trÃªn mÃ¡y báº¡n. Má»—i khi muá»‘n táº¯t server, báº¡n cÃ³ thá»ƒ vÃ o terminal dÃ¹ng Ä‘á»ƒ cháº¡y server vÃ  nháº¥n <strong>Ctrl + C</strong> lÃ  xong.</p><p>NgoÃ i viá»‡c isolate ná»™i dung thÆ° má»¥c, Docker cÃ²n cho phÃ©p báº¡n giá»›i háº¡n tÃ i nguyÃªn cho container theo Ã½ thÃ­ch. Báº¡n cÃ³ thá»ƒ giá»›i háº¡n sá»‘ CPU mÃ  container Ä‘Æ°á»£c sá»­ dá»¥ng, hoáº·c lÆ°á»£ng RAM tá»‘i Ä‘a Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ trÃ¡nh trÆ°á»ng há»£p háº¿t RAM gÃ¢y Ä‘á»©ng mÃ¡y. TÃ¬m hiá»ƒu á»Ÿ <a href="https://docs.docker.com/config/containers/resource_constraints/">Ä‘Ã¢y</a> Ä‘á»ƒ xem cÃ¡ch lÃ m.</p><p>CÃ²n 1 váº¥n Ä‘á» mÃ  mÃ¬nh chÆ°a giáº£i quyáº¿t lÃ  lÃ m sao Ä‘á»ƒ sá»­ dá»¥ng GPU trong Docker, náº¿u báº¡n Ä‘ang lÃ m dá»± Ã¡n liÃªn quan Ä‘áº¿n Deep Learning thÃ¬ GPU cá»±c ká»³ cáº§n thiáº¿t Ä‘á»ƒ tÄƒng tá»‘c quÃ¡ trÃ¬nh huáº¥n luyá»‡n mÃ´ hÃ¬nh. VÃ¬ váº­y, mÃ¬nh sáº½ giáº£i quyáº¿t váº§n Ä‘á» nÃ y trong bÃ i viáº¿t theo.</p><p>Happy Coding!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Docker</tag>
      
      <tag>Jupyter Notebook</tag>
      
      <tag>Jupyter Lab</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LÃ m quen vá»›i Kafka: Pháº§n 1 - Chat vá»›i nhau trÃªn console</title>
    <link href="/2021/01/01/Lam-quen-voi-Kafka-Phan-1-Chat-voi-nhau-tren-console/"/>
    <url>/2021/01/01/Lam-quen-voi-Kafka-Phan-1-Chat-voi-nhau-tren-console/</url>
    
    <content type="html"><![CDATA[<p>Trong 1 há»‡ thá»‘ng theo kiáº¿n trÃºc Microservice, Ä‘á»ƒ xá»­ lÃ½ 1 khá»‘i lÆ°á»£ng dá»¯ liá»‡u lá»›n vá»›i sá»± tÃ¡c Ä‘á»™ng cá»§a nhiá»u service khÃ¡c nhau, ta pháº£i cÃ³ cÆ¡ cháº¿ Ä‘á»ƒ cÃ¡c service nÃ y giao tiáº¿p vá»›i nhau má»™t cÃ¡ch hiá»‡u quáº£, Kafka Ä‘Æ°á»£c sinh ra Ä‘á»ƒ lÃ m nhiá»‡m vá»¥ Ä‘Ã³. Trong pháº§n Ä‘áº§u tiÃªn cá»§a series â€œLÃ m quen vá»›i Kafkaâ€, mÃ¬nh sáº½ viáº¿t 1 á»©ng dá»¥ng Python dÃ¹ng Ä‘á»ƒ chat vá»›i nhau trÃªn mÃ n hÃ¬nh console Ä‘á»ƒ hiá»ƒu Ä‘Æ°á»£c nhá»¯ng tÃ­nh nÄƒng cÆ¡ báº£n cá»§a Kafka.</p><p>LÆ°u Ã½ Ä‘Ã¢y chá»‰ lÃ  1 á»©ng dá»¥ng lÃ m cho vui Ä‘á»ƒ lÃ m quen vá»›i Kafka thÃ´i chá»© khÃ´ng nÃªn Ä‘Æ°a vÃ o thá»±c táº¿ nhÃ©.</p><p><escape><a id="more"></a></escape></p><h2 id="Truoc-het-Kafka-la-gi"><a href="#Truoc-het-Kafka-la-gi" class="headerlink" title="TrÆ°á»›c háº¿t, Kafka lÃ  gÃ¬?"></a>TrÆ°á»›c háº¿t, Kafka lÃ  gÃ¬?</h2><p>Kafka lÃ  1 ná»n táº£ng event streaming ráº¥t phá»• biáº¿n hiá»‡n nay Ä‘Æ°á»£c phÃ¡t triá»ƒn bá»Ÿi tá»• chá»©c Apache vÃ  lÃ  má»™t pháº§n má»m mÃ£ nguá»“n má»Ÿ. Event streaming á»Ÿ Ä‘Ã¢y cÃ³ nghÄ©a lÃ  viá»‡c láº¥y dá»¯ liá»‡u theo thá»i gian thá»±c tá»« nhá»¯ng nguá»“n nhÆ° lÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u, cáº£m biáº¿n, thiáº¿t bá»‹ di Ä‘á»™ng, dá»‹ch vá»¥ Ä‘Ã¡m mÃ¢y vÃ  á»©ng dá»¥ng dÆ°á»›i dáº¡ng nhá»¯ng luá»“ng sá»± kiá»‡n; lÆ°u nhá»¯ng sá»± kiá»‡n nÃ y Ä‘á»ƒ sau Ä‘Ã³ cÃ³ thá»ƒ láº¥y lÃªn láº¡i vÃ  xá»­ lÃ½.</p><h3 id="Nghe-phuc-tap-qua-Tim-1-vi-du-cho-de-hieu-nao"><a href="#Nghe-phuc-tap-qua-Tim-1-vi-du-cho-de-hieu-nao" class="headerlink" title="Nghe phá»©c táº¡p quÃ¡. TÃ¬m 1 vÃ­ dá»¥ cho dá»… hiá»ƒu nÃ o!"></a>Nghe phá»©c táº¡p quÃ¡. TÃ¬m 1 vÃ­ dá»¥ cho dá»… hiá»ƒu nÃ o!</h3><p>TÆ°á»Ÿng tÆ°á»£ng báº¡n Ä‘ang xem kÃªnh Discovery trÃªn TV cá»§a báº¡n. Nhá»¯ng hÃ¬nh áº£nh vÃ  Ã¢m thanh mÃ  báº¡n tháº¥y vÃ  nghe Ä‘Æ°á»£c Ä‘á»u Ä‘Æ°á»£c phÃ¡t Ä‘i tá»« Ä‘Ã i truyá»n hÃ¬nh cá»§a kÃªnh nÃ y. á» Ä‘Ã¢y, Ä‘Ã i truyá»n hÃ¬nh cá»§a kÃªnh Discovery Ä‘Ã³ng vai trÃ² lÃ  <strong>publisher</strong>, cÃ²n báº¡n - ngÆ°á»i xem lÃ  <strong>subscriber</strong> vÃ  kÃªnh Discovery chÃ­nh lÃ  <strong>topic</strong>.</p><p>Publisher cÃ³ nhiá»‡m vá»¥ lÃ  phÃ¡t Ä‘i thÃ´ng tin vÃ o 1 topic (kÃªnh), thÃ´ng tin trong trÆ°á»ng há»£p nÃ y lÃ  dá»¯ liá»‡u á»Ÿ dáº¡ng hÃ¬nh áº£nh vÃ  Ã¢m thanh. Subscriber cÃ³ thá»ƒ Ä‘Äƒng kÃ½ Ä‘á»ƒ láº¯ng nghe trÃªn 1 topic (chá»n kÃªnh Ä‘á»ƒ xem) vÃ  nháº­n Ä‘Æ°á»£c thÃ´ng tin mÃ  publisher phÃ¡t Ä‘i. Subscriber cÅ©ng cÃ³ thá»ƒ láº¯ng nghe trÃªn nhiá»u topic (xem nhiá»u kÃªnh trÃªn nhiá»u TV, náº¿u báº¡n giÃ u vÃ  ráº£nh :D).</p><p>Äá»‘i vá»›i publisher, viá»‡c ai nháº­n Ä‘Æ°á»£c thÃ´ng tin khÃ´ng quan trá»ng, miá»…n lÃ  cá»© cÃ³ thÃ´ng tin thÃ¬ nÃ³ sáº½ phÃ¡t Ä‘i vÃ o 1 hoáº·c nhiá»u topic cá»¥ thá»ƒ. CÃ²n Ä‘á»‘i vá»›i subscriber, publisher nÃ o phÃ¡t khÃ´ng quan trá»ng, miá»…n lÃ  topic Ä‘Ã³ cÃ³ thÃ´ng tin thÃ¬ cá»© láº¥y ra mÃ  xá»­ lÃ½.</p><h2 id="Viet-ung-dung-chat-tren-console"><a href="#Viet-ung-dung-chat-tren-console" class="headerlink" title="Viáº¿t á»©ng dá»¥ng chat trÃªn console"></a>Viáº¿t á»©ng dá»¥ng chat trÃªn console</h2><p>Kafka hoáº¡t Ä‘á»™ng theo cÆ¡ cháº¿ client-server, trong Ä‘Ã³, server lÃ  1 process cháº¡y trÃªn 1 mÃ¡y tÃ­nh vÃ  client cÃ³ thá»ƒ káº¿t ná»‘i Ä‘áº¿n nÃ³ giá»‘ng nhÆ° cÃ¡ch báº¡n káº¿t ná»‘i Ä‘áº¿n database, sá»­ dá»¥ng Ä‘á»‹a chá»‰ IP vÃ  port cÃ¹ng vá»›i username vÃ  password náº¿u cÃ³. Client cÃ³ thá»ƒ lÃ  publisher, consumer hoáº·c lÃ  admin.</p><p>Viá»‡c Ä‘áº§u tiÃªn báº¡n cáº§n pháº£i lÃ m Ä‘Ã³ lÃ  khá»Ÿi Ä‘á»™ng Kafka server trÃªn 1 chiáº¿c mÃ¡y tÃ­nh.</p><h3 id="Khoi-dong-Kafka-server"><a href="#Khoi-dong-Kafka-server" class="headerlink" title="Khá»Ÿi Ä‘á»™ng Kafka server"></a>Khá»Ÿi Ä‘á»™ng Kafka server</h3><ol><li><strong>BÆ°á»›c 1</strong>: Má»Ÿ terminal lÃªn vÃ o nháº­p dÃ²ng lá»‡nh sau Ä‘á»ƒ táº£i Kafka:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/Downloads<br>wget https://downloads.apache.org/kafka/2.7.0/kafka_2.13-2.7.0.tgz<br></code></pre></td></tr></table></figure></li><li><strong>BÆ°á»›c 2</strong>: Giáº£i nÃ©n file vá»«a táº£i vá»:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar -xzf kafka_2.13-2.7.0.tgz<br><span class="hljs-built_in">cd</span> kafka_2.13-2.7.0<br></code></pre></td></tr></table></figure></li><li><strong>BÆ°á»›c 3</strong>: Khá»Ÿi Ä‘á»™ng ZooKeeper service:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bin/zookeeper-server-start.sh config/zookeeper.properties<br></code></pre></td></tr></table></figure></li><li><strong>BÆ°á»›c 4</strong>: Má»Ÿ 1 terminal má»›i vÃ  nháº­p dÃ²ng lá»‡nh sau Ä‘Ã¢y Ä‘á»ƒ báº¯t Ä‘áº§u cháº¡y Kafka server:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bin/kafka-server-start.sh config/server.properties<br></code></pre></td></tr></table></figure></li></ol><h3 id="Co-che-hoat-dong"><a href="#Co-che-hoat-dong" class="headerlink" title="CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng"></a>CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng</h3><p>TrÆ°á»›c khi báº¯t tay vÃ o viáº¿t á»©ng dá»¥ng nÃ y, mÃ¬nh sáº½ nÃ³i 1 chÃºt vá» cÃ¡ch nÃ³ hoáº¡t Ä‘á»™ng nhÆ° sau:</p><ul><li>Má»—i user khi Ä‘Æ°á»£c táº¡o sáº½ Ä‘Æ°á»£c cáº¥p cho 1 Ä‘á»‹nh danh duy nháº¥t, á»Ÿ Ä‘Ã¢y mÃ¬nh dÃ¹ng tÃªn cá»§a user cho Ä‘Æ¡n giáº£n. Má»—i user cÅ©ng sáº½ Ä‘Æ°á»£c cáº¥p 1 topic duy nháº¥t mang tÃªn cá»§a chÃ­nh user Ä‘Ã³. VÃ­ dá»¥: user cÃ³ tÃªn lÃ  user1 sáº½ Ä‘Æ°á»£c cáº¥p cho topic cÅ©ng tÃªn lÃ  user1.</li><li>Má»—i user luÃ´n subscribe vÃ o topic cá»§a chÃ­nh há», vÃ  publish vÃ o topic cá»§a cÃ¡c user khÃ¡c.</li><li>Giáº£ sá»­ user A vÃ  user B Ä‘ang chat vá»›i nhau, user A muá»‘n gá»­i tin nháº¯n cho B thÃ¬ sáº½ publish ná»™i dung tin nháº¯n vÃ o topic B, sau Ä‘Ã³ user B Ä‘ang subscribe trÃªn topic cá»§a mÃ¬nh sáº½ nháº­n Ä‘Æ°á»£c tin nháº¯n tá»« A, quÃ¡ trÃ¬nh nháº¯n tin tá»« B tá»›i A cÅ©ng diá»…n ra tÆ°Æ¡ng tá»¥.</li></ul><p><img src="/2021/01/01/Lam-quen-voi-Kafka-Phan-1-Chat-voi-nhau-tren-console/kafka-message.svg" alt="Minh há»a cÃ¡ch thá»©c giao tiáº¿p giá»¯a 2 user A vÃ  B"></p><h3 id="Code-nao"><a href="#Code-nao" class="headerlink" title="Code nÃ o"></a>Code nÃ o</h3><p>Äá»ƒ cÃ³ thá»ƒ giao tiáº¿p Ä‘Æ°á»£c vá»›i Kafka server, báº¡n cáº§n dÃ¹ng thÆ° viá»‡n kafka-python. Sá»­ dá»¥ng pip Ä‘á»ƒ cÃ i Ä‘áº·t thÆ° viá»‡n nÃ y:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install kafka-python<br></code></pre></td></tr></table></figure><p>Báº¡n cÃ³ thá»ƒ Ä‘á»c document cá»§a thÆ° viá»‡n nÃ y táº¡i <a href="https://kafka-python.readthedocs.io/en/master/usage.html">Ä‘Ã¢y</a>.</p><p>TrÆ°á»›c tiÃªn, mÃ¬nh thá»­ publish vÃ o 1 topic báº±ng Ä‘oáº¡n code sau:</p><figure class="highlight python"><figcaption><span>publisher.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaProducer<br><br>BOOTSTRAP_SERVERS = [<span class="hljs-string">&#x27;localhost:9092&#x27;</span>]<br>producer = KafkaProducer(bootstrap_servers=BOOTSTRAP_SERVERS,<br>                         value_serializer=<span class="hljs-keyword">lambda</span> value: <span class="hljs-built_in">bytes</span>(value, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br>username1 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;What is your name? &#x27;</span>)<br>username2 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Who do want connect? &#x27;</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    value = <span class="hljs-built_in">input</span>()<br>    producer.send(username2, value=value)<br>    producer.flush()<br></code></pre></td></tr></table></figure><p>Äoáº¡n code nÃ y sáº½ há»i tÃªn cá»§a báº¡n vÃ  tÃªn cá»§a user mÃ  báº¡n muá»‘n nháº¯n tin, sau Ä‘Ã³ nÃ³ báº¯t Ä‘áº§u 1 vÃ²ng láº·p forever Ä‘á»ƒ chá» báº¡n nháº­p tin nháº¯n vÃ  gá»­i tin nháº¯n Ä‘Ã³ Ä‘áº¿n topic cá»§a user kia.</p><p><code>BOOTSTRAP_SERVERS</code> chá»©a thÃ´ng tin Ä‘á»ƒ káº¿t ná»‘i Ä‘áº¿n server Kafka mÃ  mÃ¬nh vá»«a khá»Ÿi Ä‘á»™ng á»Ÿ trÃªn, vÃ¬ mÃ¬nh cháº¡y Kafka trÃªn mÃ¡y cá»§a mÃ¬nh nÃªn Ä‘á»‹a chá»‰ IP cá»§a server Kafka lÃ  localhost vÃ  port máº·c Ä‘á»‹nh lÃ  9092.</p><p>Má»™t message trong Kafka cÃ³ 2 trÆ°á»ng: <code>key</code> vÃ  <code>value</code>. Báº¡n cÃ³ thá»ƒ truyá»n báº¥t cá»© dá»¯ liá»‡u nÃ o vÃ o trong 2 trÆ°á»ng nÃ y. á» Ä‘Ã¢y mÃ¬nh chá»‰ cáº§n gá»­i ná»™i dung tin nháº¯n nÃªn dÃ¹ng trÆ°á»ng <code>value</code> lÃ  Ä‘á»§.</p><p>Dá»¯ liá»‡u trong 1 message pháº£i cÃ³ dáº¡ng <code>byte</code>. Váº­y nÃªn trÆ°á»›c khi gá»­i mÃ¬nh pháº£i chuyá»ƒn tin nháº¯n tá»« dáº¡ng <code>string</code> sang <code>byte</code> báº±ng cÃ¡ch truyá»n tham sá»‘ <code>value_serializer</code> cho 1 hÃ m lambda.</p><p>Test script nÃ y báº±ng lá»‡nh trong terminal:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python publisher.py<br></code></pre></td></tr></table></figure><p><img src="/2021/01/01/Lam-quen-voi-Kafka-Phan-1-Chat-voi-nhau-tren-console/Screenshot-2021-01-01-160825.png" alt="Cháº¡y thá»­ script chat.py vá»›i tÃªn lÃ  user1 vÃ  user2"></p><p>VÃ¬ mÃ¬nh má»›i chá»‰ cháº¡y á»Ÿ bÃªn phÃ­a user1 nÃªn khÃ´ng cÃ³ báº¥t cá»© pháº£n há»“i nÃ o tá»« user2. Giá» mÃ¬nh sáº½ viáº¿t code Ä‘á»ƒ user2 láº¯ng nghe tin nháº¯n tá»« user1:</p><figure class="highlight python"><figcaption><span>subscriber.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaConsumer<br><br>BOOTSTRAP_SERVERS = [<span class="hljs-string">&#x27;localhost:9092&#x27;</span>]<br>username2 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;What is your name? &#x27;</span>)<br><br>consumer = KafkaConsumer(username2, auto_offset_reset=<span class="hljs-string">&#x27;latest&#x27;</span>,<br>                         bootstrap_servers=BOOTSTRAP_SERVERS,<br>                         value_deserializer=<span class="hljs-keyword">lambda</span> value: value.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> consumer:<br>    <span class="hljs-built_in">print</span>(msg.value)<br></code></pre></td></tr></table></figure><p>Äoáº¡n code trÃªn khá»Ÿi táº¡o 1 instance <code>KafkaConsumer</code> Ä‘á»ƒ subscribe vÃ o topic cá»§a user2 vÃ  báº¯t Ä‘áº§u 1 vÃ²ng láº·p for Ä‘á»ƒ láº¯ng nghe trÃªn topic nÃ y. VÃ²ng láº·p for nÃ y sáº½ chá» message tá»« topic trong thá»i gian vÃ´ háº¡n vÃ  khÃ´ng bao giá» dá»«ng láº¡i trá»« khi báº¡n dá»«ng chÆ°Æ¡ng trÃ¬nh.</p><p>Tham sá»‘ <code>value_deserializer</code> lÃ  1 hÃ m Ä‘Æ°á»£c dÃ¹ng khi consumer nháº­n Ä‘Æ°á»£c message tá»« topic Ä‘á»ƒ chuyá»ƒn trÆ°á»ng <code>value</code> cá»§a message tá»« dáº¡ng <code>byte</code> trá»Ÿ vá» dáº¡ng ban Ä‘áº§u cá»§a nÃ³, trong trÆ°á»ng há»£p nÃ y lÃ  <code>string</code>.</p><p>Äá»ƒ cháº¡y script nÃ y, má»Ÿ má»™t tab terminal má»›i vÃ  cháº¡y lá»‡nh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python subscriber.py<br></code></pre></td></tr></table></figure><p>Nháº­p tÃªn user2 Ä‘á»ƒ báº¯t Ä‘áº§u láº¯ng nghe.</p><p>Quay láº¡i tab Ä‘ang cháº¡y publisher, thá»­ nháº­p 1 message báº¥t ká»³ vÃ  quay láº¡i tab Ä‘ang cháº¡y subscriber. Báº¡n sáº½ tháº¥y message mÃ  mÃ¬nh vá»«a nháº­p hiá»‡n trÃªn terminal cá»§a subscriber.</p><p><img src="/2021/01/01/Lam-quen-voi-Kafka-Phan-1-Chat-voi-nhau-tren-console/Screenshot-2021-01-01-161638.png" alt="Cháº¡y thá»­ script chat.py vá»›i tÃªn lÃ  user1 vÃ  user2"></p><p>NhÆ° váº­y lÃ  chÃºng ta Ä‘Ã£ thiáº¿t láº­p Ä‘Æ°á»£c giao tiáº¿p 1 chiá»u giá»¯a 2 user. Tiáº¿p theo, mÃ¬nh sáº½ lÃ m cho má»—i user vá»«a publish vá»«a subscribe vÃ o Kafka Ä‘á»ƒ cÃ³ thá»ƒ vá»«a gá»­i vÃ  nháº­p tin nháº¯n.</p><p>NhÆ° báº¡n tháº¥y trong 2 Ä‘oáº¡n code trÃªn, cáº£ 2 Ä‘á»u chá»©a 1 vÃ²ng láº·p vÃ´ háº¡n. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  khi user Ä‘ang gá»­i tin nháº¯n thÃ¬ khÃ´ng thá»ƒ nháº­n tin nháº¯n vÃ  ngÆ°á»£c láº¡i, vÃ¬ báº£n cháº¥t cá»§a 2 Ä‘oáº¡n code trÃªn lÃ  blocking - chÆ°Æ¡ng trÃ¬nh sáº½ chá» trong vÃ´ háº¡n Ä‘á»ƒ hoÃ n thÃ nh 1 tÃ¡c vá»¥ rá»“i má»›i chuyá»ƒn sang tÃ¡c vá»¥ káº¿ tiáº¿p.</p><p>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, mÃ¬nh sáº½ sá»­ dá»¥ng thread Ä‘á»ƒ táº¡o 1 thread cháº¡y song song vá»›i thread chÃ­nh. Thread chÃ­nh cÃ³ nhiá»‡m vá»¥ lÃ  gá»­i tin nháº¯n cho Ä‘á»‘i phÆ°Æ¡ng cÃ²n thread Ä‘Æ°á»£c táº¡o cÃ³ nhiá»‡m vá»¥ nháº­n tin nháº¯n tá»« Ä‘á»‘i phÆ°Æ¡ng.</p><p>Trong Python, Ä‘á»ƒ lÃ m viá»‡c vá»›i thread, mÃ¬nh sá»­ dá»¥ng thÆ° viá»‡n threading cÃ³ sáºµn. CÃ¡ch sá»­ dá»¥ng khÃ¡ Ä‘Æ¡n giáº£n, chá»‰ cáº§n khá»Ÿi táº¡o 1 instance <code>Thread</code> vá»›i 2 tham sá»‘: <code>target</code> lÃ  hÃ m sáº½ cháº¡y trong thread má»›i; vÃ  <code>args</code> lÃ  tham sá»‘ truyá»n vÃ o hÃ m <code>target</code>. Sau Ä‘Ã³ gá»i method <code>start</code>. VÃ­ dá»¥:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">thread = threading.Thread(target=foo, args=())<br>thread.start()<br></code></pre></td></tr></table></figure><p>Váº­y trÆ°á»›c khi báº¯t Ä‘áº§u vÃ²ng láº·p while trong publisher, mÃ¬nh chá»‰ cáº§n táº¡o 1 thread má»›i cháº¡y hÃ m cá»§a subscriber lÃ  xong. DÆ°á»›i Ä‘Ã¢y lÃ  Ä‘oáº¡n code hoÃ n chá»‰nh cá»§a chÆ°Æ¡ng trÃ¬nh:</p><figure class="highlight python"><figcaption><span>chat.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><br><span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaConsumer, KafkaProducer<br><br>BOOTSTRAP_SERVERS = [<span class="hljs-string">&#x27;localhost:9092&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">topic</span>):<br>    consumer = KafkaConsumer(topic, auto_offset_reset=<span class="hljs-string">&#x27;latest&#x27;</span>,<br>                             bootstrap_servers=BOOTSTRAP_SERVERS,<br>                             value_deserializer=<span class="hljs-keyword">lambda</span> value: value.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br>    <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> consumer:<br>        <span class="hljs-built_in">print</span>(msg.value)<br><br>username1 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;What is your name? &#x27;</span>)<br>username2 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Who do want connect? &#x27;</span>)<br><br>consumer_thread = threading.Thread(target=subscribe, args=(username2,))<br>consumer_thread.start()<br><br>producer = KafkaProducer(bootstrap_servers=BOOTSTRAP_SERVERS,<br>                         value_serializer=<span class="hljs-keyword">lambda</span> value: <span class="hljs-built_in">bytes</span>(value, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    key = username1<br>    value = <span class="hljs-built_in">input</span>()<br>    producer.send(username1, value=value)<br>    producer.flush()<br></code></pre></td></tr></table></figure><p>Báº¡n thá»­ má»Ÿ 2 tab terminal, cho má»—i terminal cháº¡y script nÃ y. Tab 1 nháº­p láº§n lÆ°á»£t user1 vÃ  user2, tab 2 nháº­p ngÆ°á»£c láº¡i user2 vÃ  user1.</p><p>Khi báº¡n nháº­p 1 tin nháº¯n á»Ÿ tab 1 vÃ  nháº¥n Enter thÃ¬ tin nháº¯n Ä‘Ã³ sáº½ Ä‘Æ°á»£c hiá»‡n trÃªn tab 2, Ä‘iá»u tÆ°Æ¡ng tá»± cÅ©ng diá»…n ra khi báº¡n nháº­p vÃ o tab 2.</p><p>Báº¡n cÃ³ thá»ƒ xem code Ä‘áº§y Ä‘á»§ cá»§a bÃ i viáº¿t nÃ y á»Ÿ <a href="https://github.com/duydvu/kafka-tutorial">Ä‘Ã¢y</a>.</p><p>NhÆ° váº­y lÃ  chÃºng ta Ä‘Ã£ hoÃ n thÃ nh xong 1 á»©ng dá»¥ng Ä‘Æ¡n giáº£n Ä‘á»ƒ chat trÃªn console báº±ng Python vÃ  Kafka. Máº·c dÃ¹ váº­y, nÃ³ váº§n cÃ²n thiáº¿u nhiá»u tÃ­nh nÄƒng quan trá»ng nhÆ°:</p><ul><li>Chá»‰ cho 2 user nháº¯n tin vá»›i nhau trong 1 phiÃªn riÃªng biá»‡t. Hiá»‡n táº¡i, náº¿u cÃ³ nhiá»u hÆ¡n 2 user thÃ¬ sáº½ cÃ³ trÆ°á»ng há»£p 1 user cÃ¹ng nháº¯n tin vá»›i 2 user khÃ¡c.</li><li>Chá»‰ cho phÃ©p user nÃ y nháº¯n tin vá»›i user kia khi Ä‘Æ°á»£c há» cho phÃ©p.</li></ul><p>MÃ¬nh sáº½ thá»±c hiá»‡n nhá»¯ng tÃ­nh nÄƒng nÃ y trong pháº§n 2 cá»§a series.</p><p>Happy Coding!</p>]]></content>
    
    
    
    <tags>
      
      <tag>Coding</tag>
      
      <tag>Kafka</tag>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cáº¥u hÃ¬nh VS Code Ä‘á»ƒ láº­p trÃ¬nh trÃªn server báº±ng Remote - SSH</title>
    <link href="/2020/12/26/Cau-hinh-VS-Code-de-code-tren-server/"/>
    <url>/2020/12/26/Cau-hinh-VS-Code-de-code-tren-server/</url>
    
    <content type="html"><![CDATA[<p>Trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ hÆ°á»›ng dáº«n cho cÃ¡c báº¡n cÃ¡ch thiáº¿t láº­p mÃ´i trÆ°á»ng láº­p trÃ¬nh trÃªn server hÆ¡n thÃ´ng qua extension Remote - SSH cá»§a VS Code.</p><p><escape><a id="more"></a></escape></p><p>TrÆ°á»›c khi báº¯t Ä‘áº§u, mÃ¬nh sáº½ tráº£ lá»i cho cÃ¢u há»i:</p><h2 id="Tai-sao-phai-lap-trinh-tren-server"><a href="#Tai-sao-phai-lap-trinh-tren-server" class="headerlink" title="Táº¡i sao pháº£i láº­p trÃ¬nh trÃªn server?"></a>Táº¡i sao pháº£i láº­p trÃ¬nh trÃªn server?</h2><p>Äá»‘i vá»›i Ä‘a sá»‘ láº­p trÃ¬nh viÃªn, 1 chiáº¿c laptop hoáº·c PC lÃ  Ä‘á»§ Ä‘á»ƒ phá»¥c vá»¥ cho cÃ´ng viá»‡c cá»§a há». Tuy nhiÃªn, Ä‘á»‘i vá»›i Data Scientist thÃ¬ Ä‘Ã´i khi lÃ m viá»‡c trÃªn 1 thiáº¿t bá»‹ lÃ  chÆ°a Ä‘á»§. Báº¡n cáº§n pháº£i lÃ m viá»‡c trÃªn mÃ¡y tÃ­nh cÃ³ cáº¥u hÃ¬nh máº¡nh, bá»™ nhá»› lá»›n Ä‘á»ƒ cÃ³ thá»ƒ load dá»¯ liá»‡u vÃ  huáº¥n luyá»‡n mÃ´ hÃ¬nh, Ä‘áº·c biá»‡t lÃ  cÃ¡c mÃ´ hÃ¬nh Deep Learning yÃªu cáº§u pháº£i cÃ³ 1 hoáº·c nhiá»u GPU vÃ  thá»i gian huáº¥n luyá»‡n cÃ³ khi lÃªn tá»›i hÃ ng tuáº§n. Nhá»¯ng chiáº¿c mÃ¡y tÃ­nh máº¡nh máº½ nhÆ° váº­y thÆ°á»ng sáº½ khÃ´ng vá»«a váº·n vá»›i 1 chiáº¿c laptop hoáº·c PC nÃªn náº¿u lÃ m viá»‡c trá»±c tiáº¿p thÃ¬ sáº½ khÃ¡ khÃ³ khÄƒn. VÃ¬ váº­y, viá»‡c láº­p trÃ¬nh trÃªn server sáº½ giÃºp Ã­ch ráº¥t nhiá»u, vÃ­ dá»¥ nhÆ°:</p><ul><li>Báº¡n cÃ³ thá»ƒ huáº¥n luyá»‡n mÃ´ hÃ¬nh mÃ  váº«n cÃ³ thá»ƒ táº¯t laptop mang Ä‘i nÆ¡i khÃ¡c.</li><li>Báº¡n cÃ³ thá»ƒ ra quÃ¡n coffee vá»›i chiáº¿c mÃ¡y tÃ­nh má»ng nháº¹ mÃ  váº«n lÃ m viá»‡c Ä‘Æ°á»£c trÃªn chiáº¿c mÃ¡y tÃ­nh khá»§ng.</li><li>Báº¡n cÃ³ thá»ƒ chia sáº» mÃ¡y vá»›i Ä‘á»“ng nghiá»‡p Ä‘á»ƒ cÃ¹ng táº­n dá»¥ng tÃ i nguyÃªn cá»§a mÃ¡y.</li></ul><p>HÆ¡n ná»¯a, cÃ¡c dá»‹ch vá»¥ Ä‘iá»‡n toÃ¡n Ä‘Ã¡m mÃ¢y nhÆ° lÃ  AWS, GCP cung cáº¥p dá»‹ch vá»¥ tÃ­nh toÃ¡n giÃºp cho chÃºng ta cÃ³ thá»ƒ lÃ m viá»‡c trÃªn nhá»¯ng chiáº¿c mÃ¡y tÃ­nh máº¡nh mÃ  khÃ´ng cáº§n pháº£i bá» 1 sá»‘ tiá»n lá»›n Ä‘á»ƒ mua hoáº·c thuÃª vá», Ä‘iá»u nÃ y cÅ©ng khiáº¿n cho viá»‡c láº­p trÃ¬nh trÃªn server ngÃ y cÃ ng trá»Ÿ nÃªn phá»• biáº¿n.</p><p>CÃ³ nhiá»u cÃ¡ch khÃ¡c nhau Ä‘á»ƒ cÃ³ thá»ƒ láº­p trÃ¬nh Ä‘Æ°á»£c trÃªn server, cÃ¡ch nhanh nháº¥t lÃ  báº­t 1 trÃ¬nh soáº¡n tháº£o vÄƒn báº£n nhÆ° Vim hoáº·c Nano rá»“i báº¯t Ä‘áº§u code. Tuy nhiÃªn, nhá»¯ng trÃ¬nh soáº¡n tháº£o nÃ y khÃ´ng cung cáº¥p sáºµn nhá»¯ng tÃ­nh nÄƒng há»¯u Ã­ch cá»§a 1 IDE nhÆ° lÃ  syntax highlighting, autocompletion, debugger. Vim lÃ  1 trÃ¬nh soáº¡n tháº£o ráº¥t tuyá»‡t vá»i vÃ¬ nÃ³ cho phÃ©p gáº¯n thÃªm plugin vÃ o Ä‘á»ƒ thÃªm tÃ­nh nÄƒng, nÃ³ cho phÃ©p báº¡n biáº¿n nÃ³ thÃ nh 1 IDE thá»±c thá»¥ thÃ´ng qua viá»‡c cÃ i Ä‘áº·t nhá»¯ng plugin Ä‘Æ°á»£c cung cáº¥p bá»Ÿi ráº¥t nhiá»u láº­p trÃ¬nh viÃªn khÃ¡c. TÃ¹y vÃ o sá»Ÿ thÃ­ch mÃ  báº¡n cÃ³ thá»ƒ chá»n Vim lÃ  cÃ´ng cá»¥ chÃ­nh cho viá»‡c láº­p trÃ¬nh trÃªn server, máº·c dÃ¹ viá»‡c thao tÃ¡c trÃªn Vim khÃ¡ phá»©c táº¡p nhÆ°ng khi báº¡n Ä‘Ã£ quen vá»›i viá»‡c sá»­ dá»¥ng nÃ³ rá»“i thÃ¬ báº¡n sáº½ tháº¥y Ä‘Æ°á»£c sá»± máº¡nh máº½ vÃ  hiá»‡u quáº£ mÃ  nÃ³ Ä‘em láº¡i. MÃ¬nh cÅ©ng hay sá»­ dá»¥ng Vim cho nhá»¯ng tÃ¡c vá»¥ edit Ä‘Æ¡n giáº£n trÃªn server vÃ¬ nÃ³ ráº¥t nhanh vÃ  tiá»‡n lá»£i. Táº¡m gÃ¡c Vim qua má»™t bÃªn, trong bÃ i nÃ y mÃ¬nh sáº½ chá»‰ táº­p trung vÃ o cÃ¡ch cáº¥u hÃ¬nh Ä‘á»ƒ báº¡n cÃ³ thá»ƒ láº­p trÃ¬nh trÃªn server thÃ´ng qua trÃ¬nh soáº¡n tháº£o VS Code ná»•i tiáº¿ng cá»§a Microsoft (náº¿u báº¡n Ä‘Ã£ tá»«ng dÃ¹ng Visual Studio rá»“i thÃ¬ nÃªn trÃ¡nh nháº§m láº«n nhÃ© vÃ¬ Ä‘Ã¢y lÃ  2 pháº§n má»m khÃ¡c nhau, Visual Studio lÃ  1 IDE cÃ²n VS Code chá»‰ lÃ  1 trÃ¬nh soáº¡n tháº£o vÄƒn báº£n mÃ  thÃ´i!).</p><p>Báº¯t Ä‘áº§u nÃ o!</p><h2 id="Cai-dat-extension-Remote-SSH"><a href="#Cai-dat-extension-Remote-SSH" class="headerlink" title="CÃ i Ä‘áº·t extension Remote - SSH"></a>CÃ i Ä‘áº·t extension Remote - SSH</h2><p>MÃ¬nh giáº£ Ä‘á»‹nh ráº±ng báº¡n Ä‘Ã£ cÃ i Ä‘áº·t sáºµn VS Code trong mÃ¡y rá»“i nÃªn mÃ¬nh sáº½ chá»‰ hÆ°á»›ng dáº«n sau khi báº¡n Ä‘Ã£ báº­t VS Code lÃªn nhÃ©.</p><p>Äá»ƒ cÃ i Ä‘áº·t extension trÃªn VS Code, báº¡n hÃ£y nháº¥n vÃ o biá»ƒu tÆ°á»£ng <strong>Extensions</strong> á»Ÿ thanh cÃ´ng cá»¥ bÃªn trÃ¡i, sau Ä‘Ã³, trÃªn thanh tÃ¬m kiáº¿m gÃµ cá»¥m tá»« <em>â€œRemote - SSHâ€</em>.</p><p>Extension mÃ  ta cáº§n tÃ¬m sáº½ xuáº¥t hiá»‡n trong káº¿t quáº£ tÃ¬m kiáº¿m, nháº¥n vÃ o Ä‘Ã³ rá»“i nháº¥n nÃºt <strong>Install</strong> Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh cÃ i Ä‘áº·t. Sau khi cÃ i Ä‘áº·t xong, khá»Ÿi Ä‘á»™ng láº¡i VS Code Ä‘á»ƒ load extension lÃªn.</p><p><img src="/2020/12/26/Cau-hinh-VS-Code-de-code-tren-server/Screenshot-2020-12-26-120808.png" alt="Giao diá»‡n VS Code sau khi hoÃ n táº¥t cÃ i Ä‘áº·t Remote - SSH"></p><p>Tiáº¿p theo, mÃ¬nh sáº½ hÆ°á»›ng dáº«n cÃ¡ch cáº¥u hÃ¬nh mÃ´i trÆ°á»ng láº­p trÃ¬nh trÃªn server.</p><h2 id="Cau-hinh-moi-truong-lap-trinh-tren-server"><a href="#Cau-hinh-moi-truong-lap-trinh-tren-server" class="headerlink" title="Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng láº­p trÃ¬nh trÃªn server"></a>Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng láº­p trÃ¬nh trÃªn server</h2><h3 id="Buoc-1-Tao-SSH-key"><a href="#Buoc-1-Tao-SSH-key" class="headerlink" title="BÆ°á»›c 1: Táº¡o SSH key"></a>BÆ°á»›c 1: Táº¡o SSH key</h3><p>TrÆ°á»›c khi káº¿t ná»‘i Ä‘áº¿n server thÃ´ng qua VS Code, báº¡n cáº§n pháº£i táº¡o 1 SSH key Ä‘á»ƒ xÃ¡c thá»±c quyá»n káº¿t ná»‘i cá»§a mÃ¡y báº¡n vá»›i server mÃ  khÃ´ng cáº§n dÃ¹ng máº­t kháº©u.<br>Náº¿u báº¡n Ä‘Ã£ cáº¥u hÃ¬nh SSH server báº±ng SSH key rá»“i thÃ¬ hÃ£y Ä‘áº¿n vá»›i <a href="#Buoc-3-Thiet-lap-moi-truong-SSH-tren-VS-Code">bÆ°á»›c 3</a>.</p><p>Má»Ÿ 1 terminal má»›i vÃ  nháº­p lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa<br></code></pre></td></tr></table></figure><p>CÃ¢u lá»‡nh trÃªn sáº½ tráº£ vá» káº¿t quáº£ nhÆ° dÆ°á»›i Ä‘Ã¢y:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">Generating public/private rsa key pair.<br>Enter passphrase (empty for no passphrase):<br></code></pre></td></tr></table></figure><p>Nháº¥n Enter 2 láº§n Ä‘á»ƒ hoÃ n táº¥t viá»‡c táº¡o SSH key trÃªn mÃ¡y tÃ­nh cá»§a báº¡n, key nÃ y Ä‘Æ°á»£c lÆ°u táº¡i <code>~/.ssh/id_rsa</code>.</p><h3 id="Buoc-2-Them-SSH-key-vao-danh-sach-authorized-keys-cua-server"><a href="#Buoc-2-Them-SSH-key-vao-danh-sach-authorized-keys-cua-server" class="headerlink" title="BÆ°á»›c 2: ThÃªm SSH key vÃ o danh sÃ¡ch authorized keys cá»§a server"></a>BÆ°á»›c 2: ThÃªm SSH key vÃ o danh sÃ¡ch authorized keys cá»§a server</h3><p>Tiáº¿p theo, báº¡n cáº§n pháº£i SSH vÃ o server Ä‘á»ƒ thÃªm SSH key mÃ  báº¡n vá»«a táº¡o vÃ o danh sÃ¡ch authorized keys cá»§a server. BÆ°á»›c nÃ y dÃ¹ng Ä‘á»ƒ xÃ¡c thá»±c quyá»n truy cáº­p vÃ o server cho mÃ¡y tÃ­nh cá»§a báº¡n.</p><p>Äáº§u tiÃªn, báº¡n cáº§n copy public key sá»­ dá»¥ng lá»‡nh dÆ°á»›i Ä‘Ã¢y:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> ~/.ssh/id_rsa.pub<br></code></pre></td></tr></table></figure><p>Copy toÃ n bá»™ ná»™i dung tráº£ vá» cá»§a lá»‡nh nÃ y.</p><p>Tiáº¿p theo, káº¿t ná»‘i SSH vÃ o server báº±ng lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh &lt;username&gt;@&lt;ip-address&gt;<br></code></pre></td></tr></table></figure><p>Thay <code>username</code> vÃ  <code>ip-address</code> thÃ nh giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng mÃ  báº¡n cÃ³. Nháº­p máº­t kháº©u Ä‘á»ƒ xÃ¡c thá»±c.</p><p>Sau Ä‘Ã³, chÃ¨n ná»™i dung cá»§a public key vÃ o cuá»‘i file <code>~/.ssh/authorized_keys</code> báº±ng lá»‡nh sau:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;paste-your-public-key-content-here&gt;&quot;</span> &gt;&gt; ~/.ssh/authorized_keys<br></code></pre></td></tr></table></figure><p>Thay <code>paste-your-public-key-content-here</code> báº±ng ná»™i dung cá»§a public key mÃ  báº¡n vá»«a copy.</p><p>NhÆ° váº­y lÃ  báº¡n Ä‘Ã£ hoÃ n táº¥t viá»‡c xÃ¡c thá»±c SSH key vá»›i server, trong nhá»¯ng láº§n ssh sau, báº¡n khÃ´ng cáº§n pháº£i cung cáº¥p máº­t kháº©u ná»¯a giÃºp cho viá»‡c ssh vÃ o server trá»Ÿ nÃªn thuáº­n tiá»‡n hÆ¡n.</p><p><strong>LÆ°u Ã½</strong>: Náº¿u á»Ÿ trong bÆ°á»›c 1, báº¡n sá»­ dá»¥ng tÃªn khÃ¡c Ä‘á»ƒ táº¡o SSH key nhÆ° <code>id_abc</code> thÃ¬ báº¡n cáº§n pháº£i lÃ m thÃªm 1 bÆ°á»›c lÃ  thay Ä‘á»•i cáº¥u hÃ¬nh SSH Ä‘á»ƒ nÃ³ biáº¿t Ä‘Æ°á»£c cáº§n pháº£i dÃ¹ng key nÃ o khi káº¿t ná»‘i Ä‘áº¿n server cá»§a báº¡n.</p><p>Trong file <code>~/.ssh/config</code>, báº¡n cáº§n thÃªm Ä‘oáº¡n dÆ°á»›i Ä‘Ã¢y vÃ o cuá»‘i file:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text"># Chá»‰ thÃªm khi file key cá»§a báº¡n khÃ¡c vá»›i máº·c Ä‘á»‹nh (id_rsa, id_dsa, id_ecdsa, id_ed25519)<br>Host &lt;ip-address&gt;<br>  HostName &lt;ip-address&gt;<br>  User &lt;username&gt;<br>  Port 22<br>  IdentityFile ~/.ssh/id_abc<br></code></pre></td></tr></table></figure><h3 id="Buoc-3-Thiet-lap-moi-truong-SSH-tren-VS-Code"><a href="#Buoc-3-Thiet-lap-moi-truong-SSH-tren-VS-Code" class="headerlink" title="BÆ°á»›c 3: Thiáº¿t láº­p mÃ´i trÆ°á»ng SSH trÃªn VS Code"></a>BÆ°á»›c 3: Thiáº¿t láº­p mÃ´i trÆ°á»ng SSH trÃªn VS Code</h3><p>Sau khi Ä‘Ã£ cÃ³ thá»ƒ káº¿t ná»‘i Ä‘áº¿n server thÃ´ng qua SSH key, báº¡n hÃ£y má»Ÿ VS Code vÃ  lÃ m theo cÃ¡c bÆ°á»›c sau Ä‘Ã¢y:</p><ol><li>Nháº¥n tá»• há»£p phÃ­m <strong>Ctrl + Shift + P</strong> Ä‘á»ƒ má»Ÿ khung <strong>Command Palette</strong>.</li><li>Nháº­p <em>â€œRemote-SSH: Add New SSH Hostâ€</em> rá»“i nháº¥n <strong>Enter</strong>.</li><li>Nháº­p cÃ¢u lá»‡nh SSH mÃ  báº¡n sá»­ dá»¥ng Ä‘á»ƒ SSH Ä‘áº¿n server: <code>ssh &lt;username&gt;@&lt;ip-address&gt;</code></li><li>Nháº­p Ä‘Æ°á»ng dáº«n Ä‘áº¿n file config: <code>~/.ssh/config</code></li></ol><p>VS Code sáº½ hiá»‡n thá»‘ng bÃ¡o ráº±ng server Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o. Giá» báº¡n chá»n biá»ƒu tÆ°á»£ng Remote Explorer á»Ÿ thanh cÃ´ng cá»¥ bÃªn trÃ¡i, báº¡n sáº½ tháº¥y Ä‘á»‹a chá»‰ ip cá»§a server vá»«a thÃªm vÃ o. Tá»« bÃ¢y giá», báº¡n cÃ³ thá»ƒ má»Ÿ 1 folder báº¥t ká»³ trÃªn server báº±ng cÃ¡ch nháº¥n nÃºt <strong>Connect to Host in New Window</strong> á»Ÿ káº¿ bÃªn Ä‘á»‹a chá»‰ ip cá»§a server.</p><p>NhÆ° váº­y lÃ  báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u láº­p trÃ¬nh trÃªn server thÃ´ng qua VS Code rá»“i Ä‘Ã³.</p><p>Má»™t lÆ°u Ã½ nhá» lÃ  khi dÃ¹ng VS Code trÃªn server thÃ¬ báº¡n cáº§n pháº£i cÃ i extension <strong>trÃªn server Ä‘Ã³</strong> thÃ¬ má»›i cÃ³ thá»ƒ dÃ¹ng Ä‘Æ°á»£c, tá»©c lÃ  náº¿u cÃ³ extension nÃ o báº¡n Ä‘Ã£ cÃ i trÃªn mÃ¡y rá»“i thÃ¬ váº«n pháº£i cÃ i láº¡i trÃªn server.</p><p>Happy coding!</p>]]></content>
    
    
    
    <tags>
      
      <tag>IDE</tag>
      
      <tag>Coding</tag>
      
      <tag>VScode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Open-closed principle</title>
    <link href="/2020/08/23/Open-closed-principle/"/>
    <url>/2020/08/23/Open-closed-principle/</url>
    
    <content type="html"><![CDATA[<p>Open-closed principle lÃ  1 trong cÃ¡c nguyÃªn táº¯c cá»§a bá»™ nguyÃªn táº¯c láº­p trÃ¬nh SOLID trong láº­p trÃ¬nh hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng. ÄÃ¢y lÃ  1 nguyÃªn táº¯c ráº¥t quan trá»ng bá»Ÿi nÃ³ giÃºp cho code cá»§a dá»± Ã¡n dá»… báº£o trÃ¬ vÃ  má»Ÿ rá»™ng, cÃ³ thá»ƒ thÃ­ch á»©ng vá»›i nhá»¯ng thay Ä‘á»•i trong mÃ´i trÆ°á»ng Agile.</p><p>NguyÃªn vÄƒn phÃ¡t biá»ƒu cá»§a nguyÃªn táº¯c nÃ y nhÆ° sau:</p><blockquote><p>â€œCÃ¡c thá»±c thá»ƒ pháº§n má»m (class, function,â€¦) nÃªn táº¡o Ä‘iá»u kiá»‡n cho viá»‡c má»Ÿ rá»™ng, nhÆ°ng háº¡n cháº¿ cho viá»‡c thay Ä‘á»•i.â€</p></blockquote><p><escape><a id="more"></a></escape></p><p>CÃ³ thá»ƒ hiá»ƒu lá»£i Ã­ch cá»§a nguyÃªn táº¯c nÃ y thÃ´ng qua 1 vÃ­ dá»¥ nhÆ° sau, giáº£ sá»­ nhÆ° báº¡n lÃ  má»™t láº­p trÃ¬nh viÃªn Ä‘ang lÃ m cho 1 cÃ´ng ty IT ná». Báº¡n vÃ o Ä‘Ã³ vá»›i vai trÃ² phÃ¡t triá»ƒn pháº§n má»m cho 1 dá»± Ã¡n cá»§a 1 team trong cÃ´ng ty. Tháº­t khÃ´ng may, mÃ£ nguá»“n cá»§a dá»± Ã¡n Ä‘Ã³ nhiá»u Ä‘áº¿n ná»—i báº¡n khÃ´ng kiá»ƒm soÃ¡t Ä‘Æ°á»£c áº£nh hÆ°á»Ÿng cá»§a nhá»¯ng thÃ nh pháº§n trong há»‡ thá»‘ng Ä‘á»‘i vá»›i nhau. NhÆ°ng cÃ´ng ty láº¡i Ä‘Ã²i há»i báº¡n pháº£i hiá»‡n thá»±c 1 tÃ­nh nÄƒng má»›i cho dá»± Ã¡n trong 1 thá»i gian ngáº¯n. Váº­y lÃ m cÃ¡ch nÃ o báº¡n cÃ³ thá»ƒ hoÃ n thÃ nh cÃ´ng viá»‡c Ä‘Æ°á»£c giao Ä‘Ãºng háº¡n? Báº¡n sá»£ ráº±ng náº¿u báº¡n hiá»‡n thá»±c tÃ­nh nÄƒng má»›i theo yÃªu cáº§u nghÄ©a lÃ  báº¡n Ä‘ang táº¡o ra 1 sá»± rá»§i ro khiá»ƒn cho há»‡ thá»‘ng khÃ´ng cÃ²n hoáº¡t Ä‘á»™ng giá»‘ng nhÆ° trÆ°á»›c. Báº¡n liÃªn tá»¥c Ä‘áº·t cÃ¢u há»i ráº±ng liá»‡u tÃ­nh nÄƒng má»›i Ä‘Æ°á»£c thÃªm vÃ o cÃ³ lÃ m phÃ¡ vá»¡ nhá»¯ng tÃ­nh nÄƒng khÃ¡c hiá»‡n cÃ³ hay khÃ´ng. Náº¿u chuyá»‡n Ä‘Ã³ tháº­t sá»± xáº£y ra thÃ¬ nÃ³ khÃ´ng háº³n hoÃ n toÃ n lÃ  lá»—i cá»§a báº¡n. CÃ¡i quan trá»ng nháº¥t trong chuyá»‡n nÃ y lÃ  cÃ¡ch mÃ  code cá»§a dá»± Ã¡n Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t káº¿ nhÆ° tháº¿ nÃ o. Náº¿u code cá»§a dá»± Ã¡n tuÃ¢n theo open-closed principle thÃ¬ báº¡n cÃ³ thá»ƒ hiá»‡n thá»±c tÃ­nh nÄƒng má»›i báº±ng cÃ¡ch viáº¿t thÃªm code cho dá»± Ã¡n, táº¡o thÃªm class káº¿ thá»«a tá»« class sáºµn cÃ³ trong dá»± Ã¡n mÃ  khÃ´ng cáº§n pháº£i thay Ä‘á»•i code cÃ³ sáºµn. Äiá»u nÃ y giÃºp giáº£m thiá»ƒu rá»§i ro phÃ¡ vá»¡ há»‡ thá»‘ng Ä‘ang hoáº¡t Ä‘á»™ng mÃ  váº«n hoÃ n thÃ nh Ä‘Æ°á»£c tiáº¿n Ä‘á»™ cÃ´ng viá»‡c cá»§a báº¡n. Trong khi Ä‘Ã³, náº¿u dá»± Ã¡n Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘i ngÆ°á»£c láº¡i open-closed principle thÃ¬ báº¡n cÃ³ thá»ƒ pháº£i thay Ä‘á»•i code cá»§a dá»± Ã¡n. RÃµ rÃ ng lÃ  Ä‘iá»u nÃ y tiá»m áº©n nhiá»u rá»§i ro hÆ¡n vÃ  cÅ©ng khÃ³ hiá»‡n thá»±c hÆ¡n trÆ°á»ng há»£p Ä‘áº§u tiÃªn.</p><p>NhÆ° váº­y, ta Ä‘Ã£ tháº¥y Ä‘Æ°á»£c lá»£i Ã­ch cá»§a viá»‡c thiáº¿t káº¿ code theo open-closed principle rá»“i. Váº­y code nhÆ° tháº¿ nÃ o má»›i gá»i lÃ  tuÃ¢n theo nguyÃªn táº¯c Ä‘Ã³? Ta hÃ£y tiáº¿p tá»¥c tÃ¬m hiá»ƒu thÃ´ng qua vÃ­ dá»¥ Python dÆ°á»›i Ä‘Ã¢y.</p><p>MÃ¬nh Ä‘ang lÃ m 1 dá»± Ã¡n xÃ¢y dá»±ng mÃ´ hÃ¬nh phÃ¢n loáº¡i spam cho vÄƒn báº£n sá»­ dá»¥ng Machine Learning. Äá»ƒ cho dá»… hiá»ƒu, mÃ¬nh sáº½ bá» qua pháº§n hiá»‡n thá»±c cá»§a mÃ´ hÃ¬nh mÃ  chá»‰ táº­p trung vÃ o pháº§n code Ä‘á»ƒ sá»­ dá»¥ng mÃ´ hÃ¬nh mÃ  thÃ´i.</p><p>Giáº£ sá»­ nhÆ° mÃ¬nh Ä‘Ã£ xÃ¢y dá»±ng xong 1 mÃ´ hÃ¬nh cÃ³ input lÃ  1 Ä‘oáº¡n vÄƒn báº£n vÃ  output ra lÃ  1 sá»‘ hoáº·c 0 hoáº·c 1, 0 nghÄ©a lÃ  khÃ´ng pháº£i spam cÃ²n 1 nghÄ©a lÃ  spam. NhÆ°ng trÆ°á»›c khi Ä‘Æ°a nÃ³ vÃ o cháº¡y thá»±c táº¿, mÃ¬nh cáº§n pháº£i Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh nÃ y cÃ³ hoáº·c Ä‘á»™ng tá»‘t hay khÃ´ng báº±ng viá»‡c cho nÃ³ dá»± Ä‘oÃ¡n 1 táº­p nhiá»u vÄƒn báº£n khÃ¡c nhau vÃ  tÃ­nh tá»· lá»‡ pháº§n trÄƒm mÃ  nÃ³ dá»± Ä‘oÃ¡n Ä‘Ãºng. Váº­y mÃ¬nh sáº½ hiá»‡n thá»±c 1 hÃ m Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh nhÆ° sau:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ÄÃ¢y lÃ  hÃ m dÃ¹ng Ä‘á»ƒ láº¥y output cá»§a mÃ´ hÃ¬nh</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; np.array:<br>    <span class="hljs-comment"># HÃ m nÃ y sáº½ dÃ¹ng mÃ´ hÃ¬nh Ä‘Ã£ Ä‘Æ°á»£c huáº¥n luyá»‡n Ä‘á»ƒ cháº¡y rá»“i tráº£ vá» káº¿t quáº£ cá»§a mÃ´ hÃ¬nh</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_spam_model</span>(<span class="hljs-params">texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], truth_labels: np.array</span>) -&gt; <span class="hljs-built_in">float</span>:<br>    predicted_labels = predict(texts)<br>    num_correct_predictions = np.<span class="hljs-built_in">sum</span>(predicted_labels == truth_labels) <span class="hljs-comment"># TÃ­nh sá»‘ láº§n mÃ  mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n Ä‘Ãºng</span><br>    num_total_predictions = <span class="hljs-built_in">len</span>(texts) <span class="hljs-comment"># Tá»•ng sá»‘ vÄƒn báº£n mÃ  mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n.</span><br>    accuracy = num_correct_predictions / num_total_predictions <span class="hljs-comment"># TÃ­nh accuracy cá»§a mÃ´ hÃ¬nh</span><br>    <span class="hljs-keyword">return</span> accuracy<br></code></pre></td></tr></table></figure><p>Khi cháº¡y hÃ m nÃ y, mÃ¬nh nháº­n tháº¥y káº¿t quáº£ Ä‘Ã¡nh giÃ¡ cá»§a mÃ´ hÃ¬nh khÃ´ng Ä‘áº¡t yÃªu cáº§u Ä‘á» ra nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh thá»­ dÃ¹ng 1 phÆ°Æ¡ng phÃ¡p má»›i Ä‘á»ƒ cáº£i thiá»‡n Ä‘á»™ chÃ­nh xÃ¡c cá»§a mÃ´ hÃ¬nh. Sau khi hiá»‡n thá»±c láº¡i xong, mÃ¬nh nháº­n tháº¥y hÃ m <code>predict</code> khÃ´ng thá»ƒ cháº¡y Ä‘Æ°á»£c mÃ´ hÃ¬nh má»›i vÃ¬ báº¡n Ä‘Ã£ dÃ¹ng thÆ° viá»‡n khÃ¡c Ä‘á»ƒ hiá»‡n thá»±c nÃ³. Báº¡n thay Ä‘á»•i code cá»§a mÃ¬nh thÃ nh nhÆ° sau:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], model_name: <span class="hljs-built_in">str</span></span>) -&gt; np.array:<br>    <span class="hljs-keyword">if</span> model_name == <span class="hljs-string">&#x27;v1&#x27;</span>:<br>        <span class="hljs-comment"># Cháº¡y mÃ´ hÃ¬nh Ä‘áº§u tiÃªn</span><br>    <span class="hljs-keyword">elif</span> model_name == <span class="hljs-string">&#x27;v2&#x27;</span>:<br>        <span class="hljs-comment"># Cháº¡y mÃ´ hÃ¬nh thá»© hai</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;No such model.&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_spam_model</span>(<span class="hljs-params">texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], truth_labels: np.array, model_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:<br>    predicted_labels = predict(texts, model_name)<br>    num_correct_predictions = np.<span class="hljs-built_in">sum</span>(predicted_labels == truth_labels) <span class="hljs-comment"># TÃ­nh sá»‘ láº§n mÃ  mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n Ä‘Ãºng</span><br>    num_total_predictions = <span class="hljs-built_in">len</span>(texts) <span class="hljs-comment"># Tá»•ng sá»‘ vÄƒn báº£n mÃ  mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n.</span><br>    accuracy = num_correct_predictions / num_total_predictions <span class="hljs-comment"># TÃ­nh accuracy cá»§a mÃ´ hÃ¬nh</span><br>    <span class="hljs-keyword">return</span> accuracy<br></code></pre></td></tr></table></figure><p>á» Ä‘Ã¢y ta cÃ³ 2 váº¥n Ä‘á»:</p><ol><li>Viá»‡c thÃªm code vÃ o hÃ m <code>predict</code> lÃ m tÄƒng rá»§i ro sinh ra bug cho hÃ m nÃ y. Náº¿u nhÆ° mÃ¬nh chá»‰ cÃ³ 2 hoáº·c 3 mÃ´ hÃ¬nh thÃ¬ khÃ´ng thÃ nh váº¥n Ä‘á». NhÆ°ng giáº£ sá»­ khi mÃ¬nh cÃ³ tá»›i hÃ ng chá»¥c mÃ´ hÃ¬nh khÃ¡c nhau thÃ¬ Ä‘á»“ng nghÄ©a vá»›i viá»‡c hÃ m nÃ y sáº½ vÃ´ cÃ¹ng dÃ i vÃ  khÃ³ Ä‘á»c. Khi Ä‘Ã³ thÃ¬ viá»‡c kiá»ƒm tra lá»—i sáº½ trá»Ÿ nÃªn khÃ³ khÄƒn hÆ¡n.</li><li>Viá»‡c thay Ä‘á»•i signature cá»§a hÃ m <code>predict</code> khiáº¿n cho nhá»¯ng hÃ m sá»­ dá»¥ng nÃ³ cÅ©ng thay Ä‘á»•i theo. Trong trÆ°á»ng há»£p nÃ y thÃ¬ chá»‰ cÃ³ 1 mÃ¬nh hÃ m <code>evaluate_spam_model</code> lÃ  pháº£i thay Ä‘á»•i. NhÆ°ng náº¿u nhÆ° mÃ¬nh cÃ³ hÃ m khÃ¡c sá»­ dá»¥ng hÃ m <code>evaluate_spam_model</code> thÃ¬ sao? VÃ­ dá»¥ nhÆ° hÃ m <code>report_spam_performance</code> sá»­ dá»¥ng hÃ m <code>evaluate_spam_model</code> Ä‘á»ƒ cháº¡y ra káº¿t quáº£ vÃ  output ra 1 report Ä‘á»ƒ mÃ¬nh xem. NhÆ° váº­y, viá»‡c thay Ä‘á»•i signature cá»§a 1 hÃ m cÃ³ thá»ƒ dáº«n Ä‘áº¿n viá»‡c thay Ä‘á»•i signature cá»§a toÃ n bá»™ hÃ m trá»±c tiáº¿p hoáº·c giÃ¡n tiáº¿p sá»­ dá»¥ng nÃ³.</li></ol><p>RÃµ rÃ ng lÃ  Ä‘oáº¡n code trÃªn khÃ´ng tuÃ¢n theo open-closed principle. Váº­y code tuÃ¢n theo nguyÃªn táº¯c nÃ y sáº½ trÃ´ng nhÆ° tháº¿ nÃ o? HÃ£y xem Ä‘oáº¡n code dÆ°á»›i Ä‘Ã¢y:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpamStrategy</span>(<span class="hljs-title class_ inherited__">ABC</span>): <span class="hljs-comment"># Khai bÃ¡o class káº¿ thá»«a Abstract Base Classes. Link: https://docs.python.org/3/library/abc.html#abc.ABC</span><br><span class="hljs-meta">    @abstractmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; np.array:<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpamV1Strategy</span>(<span class="hljs-title class_ inherited__">SpamStrategy</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self, text: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; np.array:<br>        <span class="hljs-comment"># Cháº¡y mÃ´ hÃ¬nh thá»© nháº¥t</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpamV2Strategy</span>(<span class="hljs-title class_ inherited__">SpamStrategy</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self, text: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; np.array:<br>        <span class="hljs-comment"># Cháº¡y mÃ´ hÃ¬nh thá»© hai</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_spam_model</span>(<span class="hljs-params">texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], truth_labels: np.array, strategy: SpamStrategy</span>):<br>    predicted_labels = strategy.predict(texts, model_name)<br>    num_correct_predictions = np.<span class="hljs-built_in">sum</span>(predicted_labels == truth_labels) <span class="hljs-comment"># TÃ­nh sá»‘ láº§n mÃ  mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n Ä‘Ãºng</span><br>    num_total_predictions = <span class="hljs-built_in">len</span>(texts) <span class="hljs-comment"># Tá»•ng sá»‘ vÄƒn báº£n mÃ  mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n.</span><br>    accuracy = num_correct_predictions / num_total_predictions <span class="hljs-comment"># TÃ­nh accuracy cá»§a mÃ´ hÃ¬nh</span><br>    <span class="hljs-keyword">return</span> accuracy<br></code></pre></td></tr></table></figure><p>á» Ä‘Ã¢y, mÃ¬nh khai bÃ¡o 1 abstract class <code>SpamStrategy</code> cÃ³ khai bÃ¡o 1 hÃ m abstract lÃ  <code>predict</code>. Má»—i láº§n hiá»‡n thá»±c 1 mÃ´ hÃ¬nh spam má»›i thÃ¬ mÃ¬nh sáº½ táº¡o thÃªm 1 class má»›i káº¿ thá»«a tá»« class nÃ y rá»“i cháº¡y hÃ m <code>evaluate_spam_model</code> báº±ng viá»‡c thay Ä‘á»•i tham sá»‘ strategy. NhÆ° váº­y, má»—i láº§n mÃ¬nh hiá»‡n thá»±c thÃªm 1 mÃ´ hÃ¬nh má»›i thÃ¬ Ä‘oáº¡n code cá»§a nhá»¯ng mÃ´ hÃ¬nh cÅ© (nhá»¯ng class káº¿ thá»«a tá»« <code>SpamStrategy</code>) khÃ´ng bá»‹ thay Ä‘á»•i. Náº¿u nhÆ° mÃ¬nh nháº­n tháº¥y mÃ´ hÃ¬nh má»›i khÃ´ng Ä‘Æ°á»£c tá»‘t nhÆ° mÃ´ hÃ¬nh cÅ© thÃ¬ mÃ¬nh váº«n cÃ³ thá»ƒ dá»… dÃ ng cháº¡y láº¡i mÃ´ hÃ¬nh cÅ© chá»‰ báº±ng viá»‡c thay Ä‘á»•i tham sá»‘ cá»§a hÃ m <code>evaluate_spam_model</code> mÃ  thÃ´i!</p><p>ThÃ´ng qua vÃ­ dá»¥ trÃªn, chÃºng ta tháº¥y Ä‘Æ°á»£c táº§m quan trá»ng cá»§a viá»‡c thiáº¿t káº¿ code theo open-closed principle. Äá»‘i vá»›i nhá»¯ng dá»± Ã¡n nhá», nguyÃªn táº¯c nÃ y Ä‘Ã´i khi lÃ  khÃ´ng cáº§n thiáº¿t bá»Ÿi nÃ³ khiáº¿n cho code trá»Ÿ nÃªn dÃ i dÃ²ng hÆ¡n. NhÆ°ng khi dá»± Ã¡n phÃ¬nh to ra vá»›i vÃ´ sá»‘ hÃ m vÃ  class Ä‘Æ°á»£c thÃªm vÃ o thÃ¬ ta má»›i tháº¥y rÃµ Ä‘Æ°á»£c táº§m quan trá»ng cá»§a nguyÃªn tÃ¡c nÃ y.</p>]]></content>
    
    
    
    <tags>
      
      <tag>Python</tag>
      
      <tag>OOP</tag>
      
      <tag>Software Engineering</tag>
      
      <tag>SOLID</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Sá»± Ä‘á»‘i láº­p giá»¯a Object vÃ  Data Structure</title>
    <link href="/2020/08/09/su-doi-lap-giua-object-va-data-structure/"/>
    <url>/2020/08/09/su-doi-lap-giua-object-va-data-structure/</url>
    
    <content type="html"><![CDATA[<p>BÃ i viáº¿t nÃ y lÃ  kiáº¿n thá»©c mÃ¬nh há»c Ä‘Æ°á»£c khi Ä‘á»c cuá»‘n <em>Clean Code: A Handbook of Agile Software Craftsmanship</em>, mÃ¬nh muá»‘n thÃ´ng qua bÃ i viáº¿t nÃ y cÃ³ thá»ƒ chia sáº» hiá»ƒu biáº¿t cá»§a mÃ¬nh vá»›i má»i ngÆ°á»i cÅ©ng nhÆ° tá»± giÃºp báº£n thÃ¢n náº¯m vá»¯ng hÆ¡n nhá»¯ng gÃ¬ Ä‘Ã£ Ä‘á»c Ä‘Æ°á»£c.</p><p>Trong láº­p trÃ¬nh hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng, 2 khÃ¡i niá»‡m object vÃ  data structure cÃ³ sá»± Ä‘á»‘i láº­p nhau rÃµ rÃ ng máº·c dÃ¹ nghe thÃ¬ chÃºng cÃ³ váº» hÆ¡i hÆ¡i giá»‘ng nhau. Trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ tÃ¬m hiá»ƒu vÃ  phÃ¢n tÃ­ch sá»± Ä‘á»‘i láº­p nÃ y thÃ´ng qua 1 vÃ­ dá»¥ thá»±c táº¿.</p><p><escape><a id="more"></a></escape></p><h2 id="Su-khac-nhau-giua-Object-va-Data-Structure"><a href="#Su-khac-nhau-giua-Object-va-Data-Structure" class="headerlink" title="Sá»± khÃ¡c nhau giá»¯a Object vÃ  Data Structure"></a>Sá»± khÃ¡c nhau giá»¯a Object vÃ  Data Structure</h2><p>Object Ä‘Ã³ng gÃ³i toÃ n bá»™ dá»¯ liá»‡u cá»§a nÃ³ bÃªn trong 1 class vÃ  chá»‰ cung cáº¥p ra bÃªn ngoÃ i má»™t hoáº·c nhiá»u hÃ m Ä‘á»ƒ ngÆ°á»i dÃ¹ng gá»i. NhÆ° váº­y, chá»‰ cÃ³ cÃ¡c hÃ m bÃªn trong 1 class má»›i cÃ³ thá»ƒ quáº£n lÃ½ dá»¯ liá»‡u cá»§a class Ä‘Ã³. NgÆ°á»£c láº¡i, data structure Ä‘á»ƒ phÆ¡i bÃ y dá»¯ liá»‡u cá»§a nÃ³ vÃ  khÃ´ng cÃ³ báº¥t ká»³ hÃ m nÃ o cÃ³ Ã½ nghÄ©a.</p><p>Ta cÃ³ thá»ƒ tháº¥y trong Ä‘oáº¡n vÄƒn trÃªn, object vÃ  data structure hoÃ n toÃ n Ä‘á»‘i láº­p nhau. Má»™t bÃªn thÃ¬ giáº¥u dá»¯ liá»‡u vÃ  phÆ¡i bÃ y hÃ m, cÃ²n má»™t bÃªn thÃ¬ phÆ¡i bÃ y dá»¯ liá»‡u vÃ  khÃ´ng cÃ³ hÃ m (coi nhÆ° giáº¥u).</p><h2 id="Vi-du"><a href="#Vi-du" class="headerlink" title="VÃ­ dá»¥"></a>VÃ­ dá»¥</h2><p>MÃ¬nh hÃ£y cÃ¹ng xem xÃ©t 1 vÃ­ dá»¥ nhÆ° sau:<br>DÆ°á»›i Ä‘Ã¢y lÃ  1 Ä‘oáº¡n code viáº¿t theo hÆ°á»›ng data structure. Má»—i shape chá»‰ Ä‘Æ¡n giáº£n lÃ  1 táº­p cÃ¡c thuá»™c tÃ­nh riÃªng biá»‡t cá»§a má»—i dáº¡ng hÃ¬nh há»c. Class Geometry cÃ³ nhiá»‡m vá»¥ tÃ­nh toÃ¡n cÃ¡c giÃ¡ trá»‹ cháº³ng háº¡n nhÆ° diá»‡n tÃ­ch dá»±a trÃªn 3 shape nÃ y.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> &#123;<br>    <span class="hljs-keyword">public</span> Point topLeft;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> side;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> &#123;<br>    <span class="hljs-keyword">public</span> Point topLeft;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> height;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> width;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> &#123;<br>    <span class="hljs-keyword">public</span> Point center;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> radius;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Geometry</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">area</span><span class="hljs-params">(Object shape)</span> <span class="hljs-keyword">throws</span> NoSuchShapeException &#123;<br>        <span class="hljs-keyword">if</span> (shape <span class="hljs-keyword">instanceof</span> Square) &#123;<br>            <span class="hljs-type">Square</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> (Square)shape;<br>            <span class="hljs-keyword">return</span> s.side * s.side;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shape <span class="hljs-keyword">instanceof</span> Rectangle) &#123;<br>            <span class="hljs-type">Rectangle</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Rectangle)shape;<br>            <span class="hljs-keyword">return</span> r.height * r.width;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shape <span class="hljs-keyword">instanceof</span> Circle) &#123;<br>            <span class="hljs-type">Circle</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (Circle)shape;<br>            <span class="hljs-keyword">return</span> Math.PI * c.radius * c.radius;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchShapeException</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CÃ²n dÆ°á»›i Ä‘Ã¢y lÃ  1 Ä‘oáº¡n code Ä‘Æ°á»£c viáº¿t theo hÆ°á»›ng OOP, má»—i shape báº¯t buá»™c pháº£i thá»«a káº¿ tá»« class Shape vÃ  tá»± hiá»‡n thá»±c cÃ¡c hÃ m cá»§a Shape.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> &#123;<br>    <span class="hljs-keyword">private</span> Point topLeft;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> side;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">area</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> side * side;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> &#123;<br>    <span class="hljs-keyword">private</span> Point topLeft;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> height;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> width;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">area</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> height * width;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> &#123;<br>    <span class="hljs-keyword">private</span> Point center;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> radius;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">area</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Math.PI * radius * radius;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Giáº£ sá»­ nhÆ° chÃºng ta muá»‘n thÃªm 1 shape má»›i vÃ o code (Triangle cháº³ng háº¡n), Ä‘á»‘i vá»›i Ä‘oáº¡n code Ä‘áº§u tiÃªn (code theo data structure) thÃ¬ ta cáº§n khai bÃ¡o thÃªm 1 data structure má»›i tÃªn lÃ  Triangle vÃ  thay Ä‘á»•i toÃ n bá»™ hÃ m cÃ³ trong class Geometry (trong trÆ°á»ng há»£p nÃ y chá»‰ cÃ³ 1 hÃ m area). Tuy nhiÃªn, trong 1 trÆ°á»ng há»£p khÃ¡c, khi ta chá»‰ muá»‘n thÃªm 1 hÃ m má»›i Ä‘á»ƒ tÃ­nh chu vi cá»§a shape, ta chá»‰ cáº§n khai bÃ¡o 1 hÃ m tÃªn lÃ  perimeter trong class Geometry vÃ  má»i thay Ä‘á»•i chá»‰ gÃ³i gá»n trong hÃ m nÃ y mÃ  thÃ´i.<br>BÃ¢y giá» mÃ¬nh sáº½ dÃ¹ng Ä‘oáº¡n code thá»© hai (sá»­ dá»¥ng OOP) Ä‘á»ƒ Ã¡p dá»¥ng vÃ o trÆ°á»ng há»£p trÃªn. Viá»‡c thÃªm 1 shape má»›i trá»Ÿ nÃªn dá»… dÃ ng hÆ¡n ráº¥t nhiá»u so vá»›i sá»­ dá»¥ng data structure, chá»‰ cáº§n táº¡o 1 class má»›i tÃªn lÃ  Triangle vÃ  hiá»‡n thá»±c cÃ¡c hÃ m cáº§n thiáº¿t cá»§a class Shape mÃ  khÃ´ng lÃ m áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c Shape cÃ²n láº¡i. Trong khi Ä‘Ã³, náº¿u thÃªm hÃ m perimeter vÃ o class Shape thÃ¬ Ä‘Ã²i há»i ta pháº£i thay Ä‘á»•i toÃ n bá»™ code cá»§a má»i class thá»«a káº¿ tá»« Shape.</p><p>NhÆ° váº­y cÃ³ thá»ƒ tháº¥y ráº±ng:<br><strong>Äá»‘i vá»›i láº­p trÃ¬nh sá»­ dá»¥ng data structure, viá»‡c thÃªm 1 hÃ m má»›i trá»Ÿ nÃªn dá»… dÃ ng mÃ  khÃ´ng cáº§n thay Ä‘á»•i code trong nhá»¯ng data structure khÃ¡c nhÆ°ng láº¡i khÃ³ Ä‘á»ƒ thÃªm 1 data structure má»›i vÃ¬ pháº£i thay Ä‘á»•i toÃ n bá»™ hÃ m cÃ³ sáºµn. á» chiá»u ngÆ°á»£c láº¡i, láº­p trÃ¬nh theo hÆ°á»›ng Ä‘á»‘i tÆ°á»£ng khiáº¿n cho viá»‡c thÃªm 1 class má»›i dá»… dÃ ng mÃ  khÃ´ng cáº§n thay Ä‘á»•i nhá»¯ng class khÃ¡c nhÆ°ng láº¡i khÃ³ Ä‘á»ƒ thÃªm 1 hÃ m má»›i vÃ¬ toÃ n bá»™ class khÃ¡c pháº£i thay Ä‘á»•i theo.</strong></p>]]></content>
    
    
    
    <tags>
      
      <tag>OOP</tag>
      
      <tag>Software Engineering</tag>
      
      <tag>Data structure</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
